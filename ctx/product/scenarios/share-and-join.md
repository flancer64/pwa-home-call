# Сценарий: Совместное подключение через ссылку

**Путь:** ./ctx/product/scenarios/share-and-join.md

## Назначение

Описывает сценарий быстрого соединения между двумя пользователями без ручного ввода кодов. Инициатор формирует ссылку с предполагаемым именем приглашённого и целевой комнатой, отправляет её через Web Share API или любым удобным способом. Получатель открывает ссылку, видит предзаполненные значения на экране `enter`, подтверждает или редактирует их и подключается.

## Участники

- **Инициатор (отправитель)** — пользователь, создающий приглашение и указывающий имя приглашённого и комнату назначения (не обязана совпадать с его текущей комнатой).
- **Приглашённый (получатель)** — пользователь, открывающий ссылку и подключающийся к указанной комнате.

## Предварительные условия

- Приложение ДомоЗвон установлено или доступно по публичному URL.
- Инициатор вошёл в систему; его имя и/или последняя комната могут быть сохранены в `localStorage`.
- Устройство инициатора поддерживает Web Share API (или доступен fallback через буфер обмена).

## Основной сценарий

1. **Инициатор приглашения:**

   - Запускает действие **«Поделиться ссылкой»** (toolbar), переходит на экран `invite`.
   - На `invite` вводит «имя приглашённого» и «комнату назначения» (она может не совпадать с текущей комнатой инициатора).
   - Приложение формирует URL:

     ```text
     https://domozvon.app/?room={targetRoom}&name={inviteeName}
     ```

   - Если доступен Web Share API — вызывается `navigator.share()` с `title`, `text`, `url`; иначе ссылка копируется в буфер обмена с тост-уведомлением.
   - Инициатор отправляет ссылку любым каналом связи.

2. **Приглашённый:**

   - Получает ссылку и открывает её в браузере.
   - Если приложение не установлено, оно предлагается как PWA.
   - Приложение извлекает `room` и `name` из URL, подставляет их на экран **`enter`** (совместно с возможными локальными значениями), сохраняет подтверждённые значения в `localStorage` и выполняет подключение.
   - При успехе `HomeCall_Web_Core_App` переводит интерфейс в состояние `lobby`.

3. **Оба пользователя** оказываются в одной комнате и могут начать звонок (`call`).

## Альтернативные сценарии

- **A1.** Приглашённый изменяет имя перед подключением — приложение сохраняет новое имя в `localStorage`.
- **A2.** Web Share API недоступен — инициатор вручную вставляет ссылку в сообщение.
- **A3.** При повторном запуске приложение использует ранее сохранённые `room` и `name`.
- **A4.** Приглашённый открывает устаревшую ссылку — система сообщает о недоступности комнаты и возвращает на экран `enter`.

## Постусловия

- Инициатор и приглашённый подключены к одной комнате.
- У обоих в `localStorage` сохранены актуальные `room` и `name`.
- Приложение готово к повторному вызову без ручного ввода данных.

## Экран `invite`

- Используется **только инициатором** для формирования приглашения (ввод имени приглашённого и комнаты назначения, генерация ссылки, отправка через Web Share API/копирование).
- Получатель приглашения экран `invite` не видит; он работает с `enter`.

## Связь с другими документами

- **features/invite.md** — продуктовая функция приглашения и обмена ссылками.
- **rules/web/ui/screens/invite.md** — спецификация экрана инициатора приглашения.
- **rules/web/ui/toolbar.md** — элемент меню «Поделиться ссылкой» и обработка события `ui:action:share-link`.
