# PWA version sync

## Резюме изменений
- Привёл `service-worker.js` к декларации: версия определяется через `version.json`, старые кэши удаляются до `clients.claim()` и фиксируется лог `[ServiceWorker] Activated version …, old caches removed`.
- Убедился, что `VersionWatcher` лишь оповещает воркер о новой версии и логирует смену (`[VersionWatcher] Version change detected: …`), без прямого обращения к `caches`.
- Обновил `CacheCleaner` — теперь лог уровня info содержит шаблон `[CacheCleaner] PWA cache cleared and service worker reinstalled`, а операция очищает кэши, снимает регистрацию воркеров и перезапускает страницу.

## Детали работ
- Проверил `ctx/rules/web/pwa.md` и синхронизировал реализацию сервис-воркера с описанным шаблоном имени кэша `homecall-v{version}`, автоматическим удалением устаревших кэшей и логированием при активации новой версии.
- Добавил в `web/app/Core/VersionWatcher.mjs` инфо-лог о смене версии и сохранил существующий цикл проверки `version.json`, в том числе уведомление `skip-waiting` без прямого обращения к `caches`.
- Подправил `web/app/Pwa/CacheCleaner.mjs` — документированное сообщение логируется, после очистки снимаются сервис-воркеры и инициируется перезагрузка, чтобы добиться повторной установки воркера.

## Результаты
- `npm run test:unit` — провалено: Node.js не может найти модуль `test/unit` (сообщение `Cannot find module '/home/alex/work/app/pwa-home-call/test/unit'`).
- Сценарии обновления версии и ручной очистки по кнопке не выполнялись в CLI (нет полноценного окружения сервис-воркера), но подготовленные журналы и логика готовы к таким сценариям.
- Ссылка на коммит: ещё не создана (изменения находятся в рабочем дереве).
