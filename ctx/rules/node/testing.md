# Правила модульного тестирования Node-компонентов (ctx/rules/node/testing.md)

## Назначение

Документ устанавливает конкретные правила модульного тестирования **Node.js-части** проекта **ДомоЗвон**.  
Он детализирует рамочные принципы из `ctx/rules/arch/testing.md`, описывая структуру тестов, работу с контейнером зависимостей и правила изоляции в среде Node.js.

---

## Область применения

Правила охватывают тесты, проверяющие корректность работы серверных модулей проекта.  
Каждый тест выполняется в изолированном контейнере зависимостей `@teqfw/di`, отражающем реальную конфигурацию приложения.  
Тесты покрывают:

- сервисы (`HomeCall_Back_Service_*`);
- контракты (`HomeCall_Back_Contract_*`);
- инфраструктурные компоненты (`HomeCall_Back_App`, `HomeCall_Back_Logger` и др.).

---

## Структура каталогов

```text
project-root/
├── src/
├── test/
│   └── unit/
│       ├── helper.mjs
│       ├── Back/
│       │   ├── Logger.test.mjs
│       │   ├── App.test.mjs
│       │   └── Service/
│       │       └── Signal/
│       │           ├── SessionManager.test.mjs
│       │           └── Server.test.mjs
```

Каждый файл из `src/Back/...` имеет зеркальный тестовый файл `test/unit/Back/...`.

---

## Инициализация контейнера

Все тесты используют общий _helper_ `test/unit/helper.mjs`, создающий чистый DI-контейнер:

```js
import { createTestContainer } from "../helper.mjs";
const container = await createTestContainer();
const logger = await container.get("HomeCall_Back_Logger$");
```

Особенности:

- контейнер импортируется из `@teqfw/di`;
- резолвер настраивается на корневую директорию `src/`;
- для тестов доступен метод `enableTestMode()`;
- допускается регистрация мок-объектов только через `container.register()`.

Тест не должен напрямую импортировать исходный модуль — все обращения к коду выполняются через контейнер.

---

## Организация тестов

- Каждый модуль тестируется независимо и только по публичному API.
- В тестах применяются имитации (`mocks`) логгеров, сокетов и сетевых сервисов.
- Моки должны повторять контракт оригинального компонента, не выходя за его интерфейс.
- Все тесты изолированы: создание контейнера, регистрация моков и очистка состояния выполняются в каждом тесте отдельно.
- При необходимости взаимодействия нескольких модулей используется общий контейнер, но без внешних подключений (портов, файлов, БД).

---

## Инструменты

- Среда выполнения: **Node.js**
- Тестовый фреймворк: встроенные модули `node:test` и `node:assert/strict`.
- Рекомендуемый запуск:

```bash
npm run test:unit
```

- Тесты должны быть идемпотентны и не изменять состояние проекта.
- Все сообщения и логи пишутся на английском языке.

---

## Контроль согласованности

1. Каждый новый модуль сопровождается зеркальным тестом.
2. Изменение интерфейса требует обновления соответствующих тестов.
3. Ошибки при выполнении `npm run test:unit` считаются нарушением архитектурного контракта.
4. Тесты должны подтверждать, что:

   - контейнер создаёт экземпляры корректно;
   - контракты реализованы полностью;
   - сервисы корректно стартуют, останавливаются и логируют жизненный цикл;
   - взаимодействие компонентов (например, Signal Server ↔ SessionManager) выполняется в пределах контракта.

---

## Принципы проектирования тестов

- **Изоляция:** каждый тест работает в отдельном окружении.
- **Контрактность:** тест проверяет только публичное поведение модуля.
- **Идемпотентность:** повторный запуск теста не изменяет состояние.
- **Репрезентативность:** тест имитирует реальные сценарии без внешних зависимостей.
- **Читаемость:** структура и имена тестов служат спецификацией поведения.

---

## Ссылки

- `ctx/rules/arch/testing.md` — рамочные принципы тестирования.
- `ctx/rules/web/testing.md` — правила тестирования Web-компонентов.
- `ctx/rules/arch/di.md` — архитектура контейнера зависимостей `@teqfw/di`.

---

## Итог

Документ определяет стандарты модульного тестирования Node.js-компонентов **ДомоЗвон**.
Он обеспечивает воспроизводимость, изоляцию, контрактную проверку и единообразие структуры тестов.
Эти правила гарантируют, что серверная часть проекта развивается согласованно с архитектурой и остаётся защищённой от регрессий.
