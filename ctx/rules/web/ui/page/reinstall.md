# Reinstall Page

**Path:** `./ctx/rules/web/ui/page/reinstall.md`

## Purpose

- Документирует `/reinstall.html` как единственную страницу восстановления, которая обслуживает инфраструктурные циклы без экранной логики.
- Страница содержит и описывает всю логику очистки кешей, перерегистрации сервис-воркера и возвращения пользователя на домашнюю страницу; зависимостей за пределами `/reinstall.html` нет.
- Восстановление запускается вручную только после подтверждения пользователя, то есть страница не выполняет никаких автоматических операций, пока пользователь не подтвердит намерение.

## Confirmation flow

1. При переходе на страницу пользователь видит статус, поясняющий, что на кнопке ниже запущено восстановление всех браузерных артефактов.
2. Кнопка `Запустить восстановление` поддерживает фокусировку и отключается на время выполнения, предотвращая повторные нажатия.
3. После нажатия кнопка подтверждает начало процесса, обновляет статус и запускает скрипт, описанный ниже.
4. Кнопка остаётся отключённой до тех пор, пока пользователь не установит флажок `Я подтверждаю намерение вручную восстановить приложение`, то есть механизм требует явного согласия.

## Recovery script

- Последовательность шагов не зависит от версии приложения: она выполняется всегда, когда пользователь подтверждает восстановление.
- Сначала очищаются все кеш-хранилища `CacheStorage`.
- Затем отменяются все регистрации сервис-воркеров, которые могли быть несовместимыми или аварийно застрявшими.
- Локальные хранилища (`localStorage`, `sessionStorage`) сбрасываются, чтобы убрать устаревшие ключи или предикаты.
- После очистки заново регистрируется `service-worker.js` с `scope: '/'`; как только воркер становится `ready`, устанавливается контроллер и отправляется команда `clear-caches-and-rebuild`.
- По завершении пользователь получает сообщение о готовности и через короткую задержку происходит `location.replace('/')`.

## Role in the PWA contour

- `/reinstall.html` не полагается на REST-ответы или файл `version.json`; страница сама хранит статус и текст и может использоваться как ручной инструмент восстановления.
- При неудачной загрузке `index.html` его самоконтролирующийся скрипт срабатывает и перенаправляет пользователя сюда, где, после подтверждения, выполняется восстановление.
- Документ обеспечивает договоренность о том, что все действия восстановления описаны и могут быть реализованы напрямую из описания, без обходных веток и ветвящихся залежностей.
