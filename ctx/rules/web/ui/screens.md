# UI Screen Contour

**Путь**: ./rules/web/ui/screens.md

Этот документ фиксирует **структуру экранов** браузерного уровня ДомоЗвон и описывает сценарные переходы между ними. Он не вдаётся в детализацию конкретных кнопок, а концентрируется на ролях состояний, подготовке данных при запуске и каналах уведомлений, которыми распоряжается UI через `HomeCall_Web_Ui_Toast`.

## Назначение

Экранный контур реализует пользовательский поток **вход → лобби → звонок → завершение**, согласованный с приложением `ctx/rules/web/app.md`. Он определяет, какие состояния доступны пользователю, как они переходит одно к другому и на какие внешние контексты опирается UI при инициализации.

## Экранный каркас

1. **enter** — запуск, подготовка к подключению, загрузка сохранённых данных и приветственные уведомления.
2. **invite** — подтверждение параметров подключения, согласование `room/name` с локальным хранилищем и готовность к отправке приглашения.
3. **lobby** — ожидание собеседников, выбор участника и кнопки выхода.
4. **call** — активная видеосессия, отображение потоков и повторные запросы устройств.
5. **end** — подведение итогов вызова и возврат к лобби.

## Поведение при запуске

При старте `HomeCall_Web_Core_App` инициирует `HomeCall_Web_Ui_Screen_Enter` и выполняет три важных шага:

- Проверяет `HomeCall_Web_Infra_Storage` на наличие `userName` / `roomName` и передаёт их в UI — если запись найдена, стек `HomeCall_Web_Ui_Toast` выводит уведомление о загрузке сохранённых данных и позволяет пользователю подтвердить их или отредактировать.
- Распознаёт параметры URL (`?room=` и `?name=`) и дополняет ими значения из `localStorage`, чтобы сценарий совместного подключения (`ctx/product/scenarios/share-and-join.md`) мог сработать без ручного ввода.
- Инициализирует `HomeCall_Web_Media_Manager` для подготовки камеры/микрофона и связывает статусные блоки с `toast` — любое состояние (готовность, отказ, повторная попытка) дублируется через пуши `info` / `warn` / `error` в `HomeCall_Web_Ui_Toast`.

Если после автозаполнения URL содержит хотя бы один параметр, `HomeCall_Web_Core_App` переводит поток в `invite`, чтобы пользователь увидел итоговые `room`/`name`, утвердил или скорректировал их и при необходимости отправил ссылку. После подтверждения через `invite` приложение продолжает схему `lobby → call → end`, а если пользователь отменяет — возвращается на `enter`.

## Схема переходов

- **enter → invite:** при наличии `room` или `name` в URL или по клику «Поделиться ссылкой» система переключается на `invite`, чтобы синхронизировать параметры с `HomeCall_Web_Infra_Storage`, показать подтверждение через `HomeCall_Web_Ui_Toast` и предложить отправку ссылки.
- **invite → lobby:** после подтверждения `room`/`name`, сохранения в `HomeCall_Web_Infra_Storage` и успеха `HomeCall_Web_Net_SignalClient.join` поток переходит в `lobby`, обновляя toolbar и убирая сообщения `connectionMessage`.
- **enter → lobby:** при отсутствии share-данных пользователь напрямую подключается к сигнализации, как прежде.
- **lobby → call:** выбор участника инициирует `HomeCall_Web_Rtc_Peer`, `Media` подготавливает локальные дорожки, а UI показывает экран звонка с миниатюрой и сообщением о состоянии коннекта.
- **call → end:** завершение вызова (ручное или из-за ошибки сети) запускает `endCall`, очищает медиа и прекращает соединение, сохраняя сообщение для конечного экрана.
- **end → lobby:** возвращение по кнопке `Вернуться в лобби` или завершение по timeout восстанавливает список участников и повторно показывает лобби.
- **lobby → enter:** кнопка «Выйти» отключает сигнализацию, завершает Peer и возвращает пользователя к входу, чтобы он мог подключиться заново или сменить комнату.

## Связи

- `ctx/rules/web/app.md` — высокая точка согласования состояний и ожиданий приложения.
- `ctx/rules/web/contours/ui.md` — контур UI и взаимодействие через `Shared.EventBus`.
- `ctx/product/scenarios/share-and-join.md` — сценарий, который порождает URL-параметры `room`/`name` и объясняет, как входящие данные попадают на экран `invite`.
- `ctx/product/features/share.md` — детализация функции совместного подключения, Web Share API и экрана `invite` как точки подтверждения и отправки приглашений.

## Итог

Корневый документ `screens.md` ограничивается описанием состояний, поведения запуска и переходов. Детали по элементам и уведомлениям выносятся в поддокументы `ctx/rules/web/ui/screens/enter.md`, `lobby.md`, `call.md`, `end.md`, чтобы каждый экран оставался декларативным и связанным с конкретным опытом пользователя.
