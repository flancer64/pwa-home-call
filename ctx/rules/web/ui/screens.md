# UI Screen Contour

**Путь**: ./rules/web/ui/screens.md

Этот документ фиксирует **структуру экранов** браузерного уровня ДомоЗвон и описывает сценарные переходы между ними. Он не вдаётся в детализацию конкретных кнопок, а концентрируется на ролях состояний, подготовке данных при запуске и каналах уведомлений, которыми распоряжается UI через `HomeCall_Web_Ui_Toast`.

## Назначение

Экранный контур реализует пользовательский поток **enter → lobby → call → end → lobby**, согласованный с приложением `ctx/rules/web/app.md`. Он определяет, какие состояния доступны пользователю, как они переходят одно к другому и на какие внешние контексты опирается UI при инициализации. Экран `invite` является вспомогательным и используется только инициатором приглашения для формирования ссылки.

## Экранный каркас

1. **enter** — запуск, подготовка к подключению, загрузка сохранённых данных и приветственные уведомления.
2. **invite** — вспомогательный экран инициатора для формирования приглашения: доступен через меню/toolbar, вызывается событием `ui:action:share-link` из любого состояния, позволяет ввести имя собеседника и целевую комнату, отправляет ссылку через Web Share API или копирование и не активирует подключение.
3. **lobby** — ожидание собеседников, выбор участника и кнопки выхода.
4. **call** — активная видеосессия, отображение потоков и повторные запросы устройств.
5. **end** — подведение итогов вызова и возврат к лобби.

## Поведение при запуске

При старте `HomeCall_Web_Core_App` инициирует `HomeCall_Web_Ui_Screen_Enter` и выполняет три важных шага:

- Проверяет `HomeCall_Web_Infra_Storage` на наличие `userName` / `roomName` и передаёт их в UI — если запись найдена, стек `HomeCall_Web_Ui_Toast` выводит уведомление о загрузке сохранённых данных и позволяет пользователю подтвердить их или отредактировать.
- Распознаёт параметры URL (`?room=` и `?name=`) и дополняет ими значения из `localStorage`, чтобы сценарий совместного подключения (`ctx/product/scenarios/share-and-join.md`) мог сработать без ручного ввода.
- Инициализирует `HomeCall_Web_Media_Manager` для подготовки камеры/микрофона и связывает статусные блоки с `toast` — любое состояние (готовность, отказ, повторная попытка) дублируется через пуши `info` / `warn` / `error` в `HomeCall_Web_Ui_Toast`.

Если при старте присутствуют параметры URL (`?room`, `?name`), они подставляются на `enter`. Получатель приглашения подтверждает или редактирует значения на `enter` и подключается далее в `lobby` — экран `invite` ему не показывается.
- Экран `invite` запускается вручную (`ui:action:share-link`) и не входит в сценарий автоподключения; его вызов не меняет основной поток `enter → lobby → call → end → lobby`.

## Схема переходов

- **enter|lobby|end → invite:** из любого состояния (если UX-дизайн не блокирует пункт во время активного звонка) инициатор запускает «Поделиться ссылкой» (`ui:action:share-link`) через меню/toolbar; `invite` открывается для формирования ссылки, а URL-параметры не ведут на него.
- **invite → назад:** после отправки/копирования ссылки (`invite:confirm`) или отмены (`invite:cancel`) инициатор возвращается в предыдущее состояние (например, `enter`, `lobby` или `end`).
- **enter → lobby:** при валидных данных и успешном соединении пользователь/получатель переходит в лобби напрямую.
- **lobby → call:** выбор участника инициирует `HomeCall_Web_Rtc_Peer`, `Media` подготавливает локальные дорожки, а UI показывает экран звонка с миниатюрой и сообщением о состоянии коннекта.
- **call → end:** завершение вызова (ручное или из-за ошибки сети) запускает `endCall`, очищает медиа и прекращает соединение, сохраняя сообщение для конечного экрана.
- **end → lobby:** возвращение по кнопке `Вернуться в лобби` или завершение по timeout восстанавливает список участников и повторно показывает лобби.
- **lobby → enter:** кнопка «Выйти» отключает сигнализацию, завершает Peer и возвращает пользователя к входу, чтобы он мог подключиться заново или сменить комнату.

## Связи

- `ctx/rules/web/app.md` — высокая точка согласования состояний и ожиданий приложения.
- `ctx/rules/web/contours/ui.md` — контур UI и взаимодействие через `Shared.EventBus`.
- `ctx/product/scenarios/share-and-join.md` — сценарий, порождающий URL-параметры `room`/`name` и описывающий роли получателя (через `enter`) и инициатора (через `invite`).
- `ctx/product/features/invite.md` — функция приглашения, Web Share API и роль `invite`.
- `ctx/rules/web/ui/toolbar.md` — событие `ui:action:share-link` для инициатора.

## Роль сценария приглашения

- Основной путь — вход/получатель: `enter → lobby → call → end → lobby` (при наличии URL-параметров поля на `enter` предзаполняются).
- Ветка инициатора: `invite` — вспомогательный экран, доступный из любого состояния через `ui:action:share-link`, формирующий и отправляющий ссылку; после `invite:confirm` инициатор возвращается в предыдущую точку основного потока без подключения.

```
enter → lobby → call → end → lobby
(invite — вспомогательный экран, доступен из любого состояния через `ui:action:share-link`)
```

## Итог

Корневый документ `screens.md` ограничивается описанием состояний, поведения запуска и переходов. Детали по элементам и уведомлениям выносятся в поддокументы `ctx/rules/web/ui/screens/enter.md`, `lobby.md`, `call.md`, `end.md`, чтобы каждый экран оставался декларативным и связанным с конкретным опытом пользователя.
