# Invite Screen

**Путь**: ./rules/web/ui/screens/invite.md

## Назначение

Экран `invite` служит промежуточной точкой между `enter` и `lobby`: он собирает и подтверждает данные для подключения, синхронизирует их с сохранённым локальным состоянием и отправляет приглашение собеседнику через Web Share API. Экран активируется, когда `HomeCall_Web_Core_App` получает параметры `room` и/или `name` из URL и нуждается в подтверждении данных до перехода в лобби или вызова.

## Порядок взаимодействия

1. `HomeCall_Web_Core_App` запускал поток и, увидев параметры `?room` или `?name`, переключает ветку UI на `invite` вместо прямого перехода в `lobby`. Параметры URL дополняют значения, загруженные ранее из `HomeCall_Web_Infra_Storage`, чтобы пользователю показалось итоговое сочетание, а `HomeCall_Web_Ui_Toast` уведомил о том, что данные захвачены из ссылки.
2. `HomeCall_Web_Ui_Screen_Invite` выводит форму ввода имени и комнаты, связывая каждый элемент с хранилищем (`HomeCall_Web_Infra_Storage`) и предоставляя пользователю возможность редактировать или подтверждать автоматически подставленные значения. Нажатие «Подтвердить» или обновление полей вызывает валидацию и сохраняет данные через `HomeCall_Web_Infra_Storage.setUserData`, а `HomeCall_Web_Ui_Toast` подтверждает успешное сохранение или указывает на ошибки (пустые поля, недопустимые символы).
3. После валидного подтверждения экран вызывает `HomeCall_Web_Net_SignalClient.join`/`connect` и сообщает `HomeCall_Web_Core_App` о готовности через `onInviteConfirmed`. `HomeCall_Web_Ui_Toast` сообщает «Параметры зафиксированы» и переводит поток дальше по `HomeCall_Web_Core_App` (обычно в `lobby`), если сигнализация верно обработала комнату.
4. Любые сбои `HomeCall_Web_Net_SignalClient` (отказ в signal или timeout) отображаются через `HomeCall_Web_Ui_Toast` (уровни `warn`/`error`), а экран остаётся доступным для корректировки данных и повторной отправки запроса.
5. `invite` остаётся актуальным для обоих: инициатор приглашения использует его, чтобы собрать ссылку и подтвердить локальные значения, а получатель проверяет автозаполненные параметры из ссылки, прежде чем подключиться. В обоих случаях именно `HomeCall_Web_Core_App` решает, когда переходить дальше: после синхронизации`room`/`name` и положительного ответа сигнализации.

## Отправка приглашения

- Пользователь может нажать кнопку «Поделиться ссылкой» в тулбаре, которая триггерит событие `ui:action:share-link`. `HomeCall_Web_Core_App` собирает текущие `room` и `name`, формирует URL и вызывает `navigator.share()` с заголовком, текстом и ссылкой.
- Если `navigator.share` не поддерживается или отклонён, приложение копирует ссылку через `navigator.clipboard.writeText` (или через временное текстовое поле) и отправляет `HomeCall_Web_Ui_Toast` с подтверждением копирования. В обоих случаях `HomeCall_Web_Ui_Toast` уведомляет о результате (успех, отказ, копирование).
- Любая ошибка доступа к буферу обмена или `navigator.share` логируется через `HomeCall_Web_Ui_Toast` и остаётся в контексте `invite`, чтобы пользователь мог повторить действие.

## Уведомления и интеграции

- `HomeCall_Web_Ui_Toast` информирует о загрузке данных из `localStorage`, успешном сохранении, ошибке сигнализации, копировании ссылки и отсутствии поддержки Web Share API.
- `HomeCall_Web_Infra_Storage` действует как единый источник, когда пользователь редактирует поля и подтверждает данные; все записи в `localStorage` сопровождаются событиями `storage:saved` или `storage:failed` на `HomeCall_Web_Shared_EventBus`.
- `HomeCall_Web_Net_SignalClient` проверяет комнату до перехода в `lobby`, обеспечивая логику join/connect в рамках `invite`, а `HomeCall_Web_Core_App` использует `onInviteConfirmed`/`onInviteFailed` для перестроения состояния (переход в `lobby` или возвращение к `invite`).

## Связи

- `ctx/rules/web/ui/screens.md` — определяет положение `invite` в общей последовательности экранов и режимы запуска.
- `ctx/rules/web/ui/toolbar.md` — описывает кнопку «Поделиться ссылкой» и связку `ui:action:share-link`.
- `ctx/product/features/share.md` — описывает бизнес-ценность совместного подключения и место `invite` в сценарии «приема и отправки» ссылок.
