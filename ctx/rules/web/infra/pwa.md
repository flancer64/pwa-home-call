# Прогрессивное веб-приложение ДомоЗвон

Документ определяет декларативную архитектуру прогрессивного веб-приложения (PWA) ДомоЗвон.  
Его цель — зафиксировать предсказуемое поведение автономности, кэширования и версионности фронтенда, чтобы обеспечить устойчивость работы независимо от сети и согласованность между пользователем, сервис-воркером и когнитивным контуром проекта.

---

## 1. Назначение

Система PWA ДомоЗвон обеспечивает:

- запуск без сети при доступности ранее загруженной сборки;
- автоматическое обновление при публикации новой версии;
- полное соответствие кэша актуальному состоянию сборки;
- детерминированное поведение при смене версии и ручном сбросе.

---

## 2. Состав компонентов

| Компонент                              | Назначение                                                                       |
| -------------------------------------- | -------------------------------------------------------------------------------- |
| **`manifest.json`**                    | декларация метаданных PWA (имя, иконки, режим отображения, точка входа);         |
| **`version.json`**                     | источник истины о версии фронтенда в формате UTC-timestamp (`YYYYMMDD-HHMMSS`);  |
| **`service-worker.js`**                | управляющий агент, обеспечивающий кэширование, автономность и обновление версий; |
| **`HomeCall_Web_Core_VersionWatcher`** | наблюдатель, синхронизирующий состояние приложения с актуальной версией;         |
| **`HomeCall_Web_Pwa_CacheCleaner`**    | внутренний помощник, очищающий кэши после системного запроса пользователя (настройки браузера/PWA). |

---

## 3. Принципы автономности

1. Кэш браузера хранит полное множество файлов, необходимых для работы DI-контейнера `@teqfw/di` в офлайн-режиме.  
   В кэш включаются все `.mjs`-модули приложения, шаблоны экранов, манифест и ресурсы интерфейса.

2. Медиа-потоки, WebSocket-соединения и внешние запросы не кэшируются и требуют подключения к сети.

3. Понятие «core-кэш» фиксирует минимальный набор ресурсов, при котором интерфейс доступен и управляем без сервера.

---

## 4. Версионность

1. Версия фронтенда — часть архитектуры, определяющая актуальность кэша.  
   Каждая версия идентифицируется значением из `web/version.json`.

2. Имя кэша определяется как `homecall-v{version}`.  
   Все иные кэши считаются устаревшими и подлежат удалению при активации новой версии.

3. Обновление версии — управляемый асинхронный цикл:

   - файл `version.json` обновляется агентом при изменениях в `./web/`;
   - `VersionWatcher` получает актуальную версию, сравнивает её с текущей и посылает активному сервис-воркеру сообщение `clear-caches-and-rebuild`;
   - сервис-воркер очищает все кэши, пересоздаёт кэш `homecall-v{version}` и снова загружает Core Assets без перерегистрации;
   - после завершения кэширования приложение продолжает работать с новой сборкой в рамках текущей сессии.

4. Процесс обновления не требует участия пользователя и выполняется прозрачно.  
   В любой момент пользователь работает только с последней опубликованной версией.

---

## 5. Роль сервис-воркера

1. Сервис-воркер поддерживает соответствие между актуальной версией и core-кэшем, сохраняя своё состояние между публикациями новых сборок.

2. При установке и активации воркер:

   - запрашивает `version.json` для определения начальной версии;
   - создаёт кэш `homecall-v{version}` и загружает набор Core Assets;
   - удаляет любые кэши, не совпадающие с текущим именем;
   - фиксирует факт активации:

     ```text
     [ServiceWorker] Activated version {version}, old caches removed
     ```

   - завершает активацию вызовом `clients.claim()`.

3. Обновление версии происходит без перерегистрации воркера: `VersionWatcher` присылает сообщение `clear-caches-and-rebuild`, и воркер:

   - удаляет все кэши (`caches.delete()` для каждой записи);
   - создаёт новый кэш `homecall-v{version}` и записывает в него Core Assets;
   - обновляет внутренние маркеры версии и имени кэша;
   - логирует результат:

     ```text
     [ServiceWorker] Cache rebuilt for version {version}
     ```

4. Очистка кэша выполняется только сервис-воркером и считается частью цикла жизненного обновления.  
   Другие компоненты не вмешиваются в этот процесс, но браузер могут инициировать ручной сброс (например, «Очистить данные сайта» или «Сбросить PWA»), и в этом случае сервис-воркер вызывает `HomeCall_Web_Pwa_CacheCleaner$` без дополнительного UI.

5. При отсутствии сети воркер обслуживает запросы из кеша до следующей синхронизации, не меняя логику доставки ресурсов.

---

## 6. Поведение наблюдателя версии

1. `HomeCall_Web_Core_VersionWatcher` периодически проверяет `/version.json` с сервера.  
   Интервал проверки фиксирован в конфигурации окружения (`60 000 мс` по умолчанию).

2. При обнаружении расхождения версий наблюдатель отправляет активному сервис-воркеру сообщение `clear-caches-and-rebuild`, чтобы инициировать пересоздание кэша без перерегистрации воркера.

3. Сам наблюдатель не управляет кэшами и не изменяет состояние хранилища.  
   Его роль — выявление новой версии и передача сигнала воркеру для безопасной перестройки cache storage.

4. Факты смены версии и запроса на пересборку кэша отражаются в логах уровня `info`:

```text
[VersionWatcher] Version change detected: {oldVersion} → {newVersion}
[VersionWatcher] Triggered cache rebuild for {newVersion}
```

---

## 7. Ручная очистка кэша

1. В интерфейсе ДомоЗвон нет кнопки «Очистить кэш» — пользователь инициирует такой сброс только через системные средства браузера или PWA (например, «Очистить данные сайта», «Сбросить PWA»).
2. При таком запросе сервис-воркер запускает `HomeCall_Web_Pwa_CacheCleaner$`, который:
   - снимает регистрацию сервис-воркеров;
   - удаляет все кэши из `CacheStorage`;
   - логирует действие (`[CacheCleaner] PWA cache cleared and service worker reinstalled`);
   - перезапускает страницу, чтобы установить новую версию воркера.
3. Эта операция доступна только через системный интерфейс и не заменяет автоматические обновления.

---

## 8. Логирование

Все действия, связанные с версиями и кэшами, фиксируются на уровне `info` стандартным клиентским логгером `HomeCall_Web_Core_Logger$`.  
Логи могут дублироваться в консоль и передаваться на сервер при включённом зеркалировании.

---

## 9. Инварианты системы

- Каждая версия фронтенда зависит от собственного кэша `homecall-v{version}`, но работает в рамках неизменного сервис-воркера.
- Старые кэши полностью удаляются при пересборке, чтобы осталась только одна актуальная копия.
- `VersionWatcher` не изменяет кэш напрямую, он инициирует процедуру через сообщение `clear-caches-and-rebuild`.
- Очистка и перестроение кэша выполняется сервис-воркером автоматически; ручной сброс инициируется системой браузера и реализуется тем же `CacheCleaner` без UI-элементов.
- После каждой пересборки все компоненты находятся в согласованном состоянии: версия, кэш и лог соответствуют друг другу.

---

## Итог

Архитектура PWA ДомоЗвон обеспечивает предсказуемое, наблюдаемое и воспроизводимое поведение при изменении версии.  
Сервис-воркер управляет жизненным циклом кэша, наблюдатель контролирует актуальность версии, а логгер фиксирует все изменения.  
Эта декларация гарантирует, что приложение в любой момент отражает последнюю опубликованную сборку и сохраняет функциональность при отсутствии сети.
