# Прогрессивное веб-приложение

**Path:** `ctx/rules/web/infra/pwa.md`

Документ фиксирует архитектуру прогрессивного веб-приложения: автономность, версионность, обновление сборки и поведение сервис-воркера.
Цель — обеспечить предсказуемый запуск, стабильную работу и согласованность состояния между клиентом, сервис-воркером и DI-контейнером.

---

## 1. Назначение

Система PWA обеспечивает:

- запуск Приложения без сети на основе ранее загруженной версии;
- автоматическое обновление при публикации новой сборки;
- согласованность кэша, версии и UI-состояния;
- детерминированный сброс и восстановление окружения.

---

## 2. Состав компонентов

| Компонент                       | Назначение                                                            |
| ------------------------------- | --------------------------------------------------------------------- |
| **`manifest.json`**             | метаданные PWA (имя, иконки, режим отображения, точка входа);         |
| **`version.json`**              | текущая версия фронтенда (`YYYYMMDD-HHMMSS`);                         |
| **`service-worker.js`**         | агент кэширования, автономности и обновления версии;                  |
| **HomeCall_Web_VersionWatcher** | обнаруживает новую версию и инициирует пересборку кэша;               |
| **HomeCall_Web_Pwa_Cache**      | выполняет очистку кэшей и локального хранилища по системному сигналу. |

---

## 3. Принципы автономности

1. **Service worker формирует core-assets самостоятельно.**
   В список входят ресурсы каталога `web/`, необходимые для запуска DI-контейнера, UI и функциональных контуров.

2. **Core-кэш содержит минимальный набор файлов для офлайн-старта.**
   Он позволяет загрузить DI, базовую логику интерфейса, шаблоны экранов и визуальные компоненты.

3. **Медиа-потоки и сигналинг работают только онлайн.**
   Их состояние не включается в core-assets, но корректно восстанавливается при возврате сети.

---

## 4. Версионность

1. Версия фронтенда определяется содержимым файла `web/version.json`.

2. Имя кэша формируется как `app-v{version}`.

3. При изменении версии:

   - обновляется `version.json`;
   - **HomeCall_Web_VersionWatcher** обнаруживает новую версию и отправляет сервис-воркеру команду `clear-caches-and-rebuild`;
   - сервис-воркер пересобирает core-кэш под новую версию.

4. Цикл обновления выполняется фоново; пользователь всегда работает с актуальной сборкой.

---

## 5. Роль сервис-воркера

1. Сервис-воркер поддерживает соответствие между версией сборки и набором core-assets.

2. При установке:

   - считывает `version.json`;
   - создаёт кэш `app-v{version}`;
   - записывает в него core-assets;
   - удаляет предыдущие версии кэша;
   - активирует клиентов (`clients.claim()`).

3. При сигнале `clear-caches-and-rebuild`:

   - удаляет все существующие кэши;
   - создаёт новый кэш `app-v{version}`;
   - записывает core-assets заново;
   - фиксирует актуальную версию.

---

## 6. Поведение наблюдателя версии

1. **HomeCall_Web_VersionWatcher** периодически запрашивает `version.json`.

2. При обнаружении изменения версии отправляет сервис-воркеру команду пересборки кэша.

3. Логи фиксируют переход версии и факт перестройки:

```text
[HomeCall_Web_VersionWatcher] Version change detected: {old} → {new}
[HomeCall_Web_VersionWatcher] Triggered cache rebuild for {version}
```

---

## 7. Механизмы ручной очистки

1. Системная очистка данных сайта или удаление PWA вызывает **HomeCall_Web_Pwa_Cache**.

2. **HomeCall_Web_Pwa_Cache**:

   - удаляет все записи `CacheStorage`;
   - сбрасывает локальное хранилище PWA-метаданных;
   - инициирует повторную установку сервис-воркера;
   - перезагружает страницу.

3. Лог фиксирует операцию:

```text
[HomeCall_Web_Pwa_Cache] PWA cache cleared and service worker reinstalled
```

---

## 8. Логирование

Все операции PWA — активация сервис-воркера, пересборка версии, очистка кэша — фиксируются клиентским логгером уровня `info`.
Логи могут выводиться локально и через удалённое зеркало, если оно включено.

---

## Итог

Архитектура PWA обеспечивает устойчивый офлайн-запуск, автоматическое обновление сборки и согласованность версии, кэша и состояния Приложения.
Service worker управляет core-кэшем и перестраивает его при обновлении версии, **HomeCall_Web_VersionWatcher** отслеживает изменение сборки, а **HomeCall_Web_Pwa_Cache** выполняет системный сброс.

---
