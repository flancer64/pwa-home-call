# Локальное хранилище браузера (`ctx/rules/web/infra/storage.md`)

## Назначение

Документ задаёт принципы работы браузерного приложения ДомоЗвон с локальным хранилищем (`localStorage` или аналогичными механизмами).  
Цель — зафиксировать ожидаемое поведение при сохранении, использовании и очистке локальных данных пользователя, не предписывая конкретный способ реализации.

---

## 1. Роль в архитектуре

Локальное хранилище относится к уровню **инфраструктуры (infra)** браузерного слоя и служит связующим элементом между пользовательским интерфейсом и контуром управления состояниями.  
Оно используется для краткосрочного сохранения минимальных пользовательских параметров, необходимых для ускоренного повторного входа в приложение.

Приложение должно оставаться функциональным при отсутствии доступа к локальному хранилищу.

---

## 2. Область ответственности

Хранилище фиксирует только один параметр, необходимый для воспроизводимости пользовательского сценария:

- имя пользователя, под которым он отображается в звонке.

Состав сохраняемых данных должен оставаться минимальным и прозрачным для пользователя.

---

## 3. Поведение системы

1. При первом вводе имени система сохраняет его в `localStorage`.
2. При последующих запусках приложение проверяет наличие имени и, если оно доступно, сразу предлагает нажать «Позвонить» или подключается по ссылке.
3. Пользователь может изменить имя один раз через форму `home`; новые значения заменяют старое имя в хранилище.
4. Очистка данных инициируется системно (например, через настройки браузера или жесты PWA) и возвращает приложение к состоянию «первого запуска».
5. Отсутствие доступа к хранилищу не считается ошибкой и не влияет на основной сценарий работы.

_(Логика синхронизации с параметрами URL и использование данных при старте приложения описываются в `ctx/rules/web/contours/core.md`.)_

---

## 4. Принципы реализации

- Хранилище находится **полностью в браузере** и не синхронизируется с сервером.
- Система должна обеспечивать **безопасную деградацию** — при ошибке чтения или записи приложение продолжает работу.
- Любой доступ к локальным данным должен быть **детерминированным и наблюдаемым** (через логи или события).
- Формат хранения должен быть устойчив к изменению версии приложения и не нарушать целостность данных при обновлениях.
- Локальные данные очищаются вместе с кэшем по решению пользователя или в ходе обновления PWA, если это предусмотрено политикой версии.

---

## 5. Взаимодействие с другими контурами

| Контур     | Роль                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| **Core**   | управляет моментом записи и чтения данных при инициализации приложения; |
| **Ui**     | предоставляет пользователю средство ввода имени на `home` и отображает статус сохранения; |
| **Shared** | фиксирует операции и ошибки, связанные с локальным хранилищем;          |
| **Pwa**    | может участвовать в очистке при обновлении версии;                      |
| **Env**    | сообщает о доступности или недоступности механизма локального хранения. |

---

## 6. Инварианты

- Приложение должно оставаться полностью работоспособным при пустом или недоступном хранилище.
- Хранилище не содержит персональных или чувствительных данных.
- Пользователь в любой момент может удалить сохранённые данные.
- Все операции с локальным хранилищем выполняются в контексте браузера пользователя.
- Поведение при сбое должно быть предсказуемым и логируемым.

---

## 7. Связи

- `ctx/rules/web/app.md` — сценарии старта и автоподключения.
- `ctx/rules/web/ui/home.md` — форма ввода имени и подтверждение, что имя сохранено.
- `ctx/rules/web/ui/share-link.md` — генерация одноразовой ссылки после сохранения имени.
- `ctx/rules/web/infra/pwa.md` — особенности очистки данных при обновлениях.

---

## Итог

Документ определяет рамочные требования к работе ДомоЗвона с локальными данными в браузере.  
Он фиксирует **что** должно быть сохранено и **каким образом** поведение должно оставаться предсказуемым и устойчивым, но не описывает логику синхронизации данных при старте или маршрутизации экранов.  
Эти механизмы определяются в `ctx/rules/web/contours/core.md`.
