# Локальное хранилище браузера (`ctx/rules/web/infra/storage.md`)

## Назначение

Документ задаёт принципы работы браузерного приложения ДомоЗвон с локальным хранилищем (`localStorage` или аналогичными механизмами).  
Цель — зафиксировать ожидаемое поведение при сохранении, использовании и очистке локальных данных пользователя, не предписывая конкретный способ реализации.

---

## 1. Роль в архитектуре

Локальное хранилище относится к уровню **инфраструктуры (infra)** браузерного слоя и служит связующим элементом между пользовательским интерфейсом и контуром управления состояниями.  
Оно используется для краткосрочного сохранения минимальных пользовательских параметров, необходимых для ускоренного повторного входа в приложение.

Приложение должно оставаться функциональным при отсутствии доступа к локальному хранилищу.

---

## 2. Область ответственности

Хранилище фиксирует только параметры, обеспечивающие воспроизводимость пользовательского сценария:

- имя пользователя, под которым он отображается в звонке;
- кодовое слово комнаты, к которой он подключается;
- временную метку последнего сохранения.

Состав сохраняемых данных должен оставаться минимальным и прозрачным для пользователя.

---

## 3. Поведение системы

1. При первом вводе имени и комнаты система сохраняет эти значения в локальном хранилище.
2. При последующих запусках приложение проверяет наличие этих данных и, если они доступны, использует их для предварительного заполнения или автоматического подключения.
3. Пользователь может изменить сохранённые параметры — новые значения заменяют старые.
4. Очистка данных инициируется пользователем и возвращает приложение к состоянию «первого запуска».
5. Отсутствие доступа к хранилищу не считается ошибкой и не влияет на основной сценарий работы.

---

## 4. Принципы реализации

- Хранилище находится **полностью в браузере** и не синхронизируется с сервером.
- Система должна обеспечивать **безопасную деградацию** — при ошибке чтения или записи приложение продолжает работу.
- Любой доступ к локальным данным должен быть **детерминированным и наблюдаемым** (через логи или события).
- Формат хранения должен быть устойчив к изменению версии приложения и не нарушать целостность данных при обновлениях.
- Локальные данные должны очищаться вместе с кэшем по решению пользователя или в ходе обновления PWA, если это предусмотрено политикой версии.

---

## 5. Взаимодействие с другими контурами

| Контур     | Роль                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| **Core**   | использует локальные данные при инициализации и обновлении состояния;   |
| **Ui**     | предоставляет пользователю управление сохранением и очисткой данных;    |
| **Shared** | фиксирует операции и ошибки, связанные с локальным хранилищем;          |
| **Pwa**    | может участвовать в очистке при обновлении версии;                      |
| **Env**    | сообщает о доступности или недоступности механизма локального хранения. |

---

## 6. Инварианты

- Приложение должно оставаться полностью работоспособным при пустом или недоступном хранилище.
- Хранилище не содержит персональных или чувствительных данных.
- Пользователь в любой момент может удалить сохранённые данные.
- Все операции с локальным хранилищем выполняются в пределах контекста браузера пользователя.
- Поведение системы при сбое хранения должно быть предсказуемым и логируемым.

---

## 7. Связи

- `ctx/rules/web/app.md` — сценарии старта и автоподключения.
- `ctx/rules/web/ui/toolbar.md` — интерфейс управления очисткой данных.
- `ctx/rules/web/infra/pwa.md` — взаимодействие с механизмом очистки кэша при обновлениях.
- `ctx/scenarios/local-storage.md` — пользовательский сценарий «Работа с локальными данными».

---

## Итог

Этот документ определяет рамочные требования к работе ДомоЗвона с локальными данными в браузере.  
Он фиксирует **что** должно быть сохранено и **каким образом** должно вести себя приложение в разных состояниях —  
но не предписывает **как именно** реализовать эти механизмы.  
Выбор конкретного метода имплементации, структуры кода и средств доступа к хранилищу остаётся за агентом,  
при условии соблюдения принципов предсказуемости, минимализма и устойчивости системы.
