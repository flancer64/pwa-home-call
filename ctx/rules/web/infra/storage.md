# Локальное хранилище браузера (`ctx/rules/web/infra/storage.md`)

## Назначение

Документ задаёт принципы работы браузерного приложения Связист с локальными хранилищами (`localStorage`, `IndexedDB` и аналогичными механизмами).  
Цель — определить, какие сведения сохраняются между сессиями, и подчеркнуть, что пользовательские данные (имена, комнаты, ссылки) в хранилище больше не фиксируются.

---

## 1. Роль в архитектуре

Локальное хранилище относится к уровню инфраструктуры и служит только вспомогательным целям, не влияющим на основной поток `home → invite → call → end`.  
Здесь сохраняются технические метаданные PWA: информация о последней проверенной версии, флаги фич и запасные переменные, которые помогают сервис-воркеру или `VersionWatcher` воспроизводить стабильное состояние.

Приложение остаётся полностью работоспособным при полном отсутствии доступа к хранилищу; ключевые сценарии формируются динамически, а `sessionId` не сохраняется между перезапусками.

---

## 2. Область ответственности

- Версия сборки: `version.json`, метка времени последнего обновления, промежуточные значения для диагностики (`lastCheckedVersion`, `lastCacheRebuild`).
- Флаги поведения PWA (`featureFlags`, `isStandalone`) — чтобы Service Worker и UI могли адаптироваться без повторных сетевых запросов.
- Вспомогательные состояния очистки (`lastCacheClear`, `pendingVersionUpdate`) — используются `HomeCall_Web_Pwa_CacheCleaner$` и `HomeCall_Web_Core_VersionWatcher`.

Хранилище не содержит пользовательских персональных данных, идентификаторов комнат или имен; всё, что необходимо сеансу, формируется в оперативной памяти.

---

## 3. Неперсонифицированные пользовательские настройки

- Разрешено сохранять флаги и параметры поведения, которые не раскрывают персональную информацию: удалённое логирование (`remoteLogging`), предпочтения визуального режима (`visualTone`, `largeControls`, `compactHint`), будущие переключатели поведения (`preferredUiFlow`, `autoToastSuppression`).
- Эти настройки не содержат `sessionId`, `link`, `name` или иных идентификаторов звонка, не участвуют в маршрутах безопасности и не влияют на доступ к микрофону/камере.
- Значения читаются при старте и применяются до отрисовки UI; изменения происходят только по явному действию пользователя через настроечные элементы (`settings`) или DI-контроллер.
- Любые новые параметры визуального поведения должны попадать в этот список и подтверждать, что они статичны, реализуемы через атрибуты компонентов и не ведут логирование персональных данных.

---

## 4. Поведение системы

1. При первой загрузке приложения проверяется наличие метаданных, и в случае несоответствия версии `VersionWatcher` инициирует очистку через `HomeCall_Web_Pwa_CacheCleaner$`.  
2. Все записи оформляются как отдельные ключи (`svyazist:lastVersion`, `svyazist:flags`); их формат JSON позволяет безопасно расширять набор полей без ломки прежних сборок.  
3. Запросы чтения и записи завершаются предсказуемо: ошибки логируются (`StorageLogger`) и не прерывают пользовательский поток.  
4. Сброс хранилища выполняется только через `CacheCleaner` или сервис-воркер по сигналу версии, а не через отдельные UI-формы. Это обеспечивает однородность `home`, где не нужны дополнительные кнопки управления локальными данными.

---

## 5. Принципы реализации

- Доступ к хранилищу ограничен уровнем Infra: другие контуры получают данные через `HomeCall_Web_Infra_Storage$`, а не напрямую.  
- Все записи детерминированы; порядок операций фиксирован и логируется через `HomeCall_Web_Shared_Logger$`.  
- Падение хранилища (например, из-за режима инкогнито) обрабатывается как отсутствие данных — приложение продолжает работать, не показывая формы или ошибки.  
- Ни одна операция со storage не затрагивает пользовательские параметры: `sessionId`, `link`, `callState` живут только в памяти и очищаются после завершения звонка.

---

## 6. Взаимодействие с другими контурами

| Контур   | Роль                                                                 |
| -------- | -------------------------------------------------------------------- |
| **Core** | читает версию и флаги перед стартом, но не сохраняет `sessionId`.     |
| **Ui**   | не опирается на хранилище для текста или состояния экранов.          |
| **Pwa**  | вызывает `CacheCleaner` и `VersionWatcher`, которые пишут/читают метаданные. |
| **Shared** | логирует операции хранения и обрабатывает ошибки.                |
| **Env**  | через `getContext()` сообщает о доступности storage и его состоянии. |

---

## 7. Инварианты

- Пользовательский поток не зависит от локального хранилища; отсутствие данных — нормальное состояние.  
- В хранилище не записываются улики о конкретных звонках (sessionId, ссылки, имена).  
- Любые изменения схемы хранения мягко деградируют: новые ключи добавляются без нарушения старых версий.  
- Очистка storage идемпотентна и инициируется только системными агентами (CacheCleaner, VersionWatcher).

---

## Итог

Локальное хранилище Связист теперь обслуживает только PWA-метаданные и флаги.  
Персональные сведения и сеансовая информация формируются в оперативной памяти и сбрасываются по завершении звонка, что упрощает UX и устраняет необходимость дополнительных форм или полей.
