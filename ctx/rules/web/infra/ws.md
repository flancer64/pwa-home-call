# Протокол сигналинга WebSocket (`ctx/rules/web/infra/ws.md`)

## Назначение

Документ фиксирует минимальный и прозрачный обмен данными через **WebSocket** во фронтенде ДомоЗвон. Сигналинг служит только для двух участников одной комнаты: инициатора и получателя, без списков или дополнительных комнат.

---

## 1. Общие положения

- Используется единственное соединение `wss://<host>/signal`, которое устанавливается при старте `app.js`.
- WebSocket отвечает за передачу SDP/ICE между двумя участниками, не за управление списками пользователей или статусами.
- Клиент реализован в `ws/client.js` и инжектируется в `Net` через DI.

---

## 2. Форматы сообщений

| Тип           | Откуда → Кому            | Поля                      | Назначение                             |
| ------------- | ------------------------ | ------------------------- | -------------------------------------- |
| `"join"`      | клиент → сервер              | `room`, `user`            | регистрация участника                   |
| `"leave"`     | клиент → сервер              | `room`, `user`            | завершение сессии                       |
| `"offer"`     | инициатор → сигналинг → получатель | `room`, `from`, `sdp`     | передача SDP-предложения               |
| `"answer"`    | получатель → сигналинг → инициатор | `room`, `from`, `sdp`     | ответ на предложение                   |
| `"candidate"` | любой участник → сигналинг → другой | `room`, `from`, `candidate` | обмен ICE-кандидатами                  |
| `"error"`     | сервер → клиент          | `room`, `message`          | уведомление об ошибке сигналинга       |

Все сообщения передаются через одно соединение и относятся к активной UUID-комнате `room=<uuid>`.

---

## 3. Поведение клиента

1. При запуске `HomeCall_Web_Core_App` устанавливает соединение и, как только имя пользователя и UUID комнаты готовы, отправляет `join` с `room` и `user`, чтобы сервер зарегистрировал участника и мог доставить накопленные сообщения собеседнику.
2. Инициатор после нажатия «Позвонить» отправляет `offer`, а затем получает `answer` и `candidate` от получателя.
3. Получатель, открыв ссылку, также шлёт `join`, принимает `offer` и отвечает `answer` со своими `candidate`.
4. При завершении звонка клиент посылает `leave`, чтобы сервер удалил сессию и освободил слот.
5. Все ошибки возвращаются как сообщения `"error"` — Core использует их для `toast.error()` и, при необходимости, переподключения.

---

## 4. Принципы реализации

- Сервер регистрирует участников через `join`/`leave` и переадресует SDP/ICE только в рамках активной комнаты без дополнительной маршрутизации.
- Повторные подключения идентичны: `room` фиксирован, и повторный `offer`/`answer` служит возобновлению; пока собеседник не появился, `offer`/`candidate` могут временно удерживаться в очереди.
- Все события и очереди логируются через `HomeCall_Web_Shared_Logger$`, при этом клиент использует только `toast` для пользовательских уведомлений.

---

## 5. Безопасность

- Подключения только по `wss://` (TLS).
- Сервер не хранит историю сигналов и не передаёт их третьим лицам.
- Проверка `room` выполняется на сервере перед публикацией `offer`.
- Сообщения от незарегистрированных комнат или `from` игнорируются.

---

## 6. Связи

- `../contours/net.md` — перевод сообщений в API `Net`.
- `../app.md` — управление состоянием `call`.
- `../contours/rtc.md` — обмен SDP/ICE.
- `../contours/core.md` — реакция на ошибки и перезапуск коллбэков.

---

## Итог

Протокол WebSocket ДомоЗвон ограничен 1:1 звонком: единственная UUID-комната, обмен `offer/answer/candidate` и автоматические `toast`-статусы. Отсутствуют пользовательские списки, `EventBus` и дополнительные экраны.
