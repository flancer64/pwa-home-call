# Протокол сигналинга WebSocket (`ctx/rules/web/infra/ws.md`)

## Назначение

Документ фиксирует минимальный, детерминированный обмен данными через `wss://<host>/signal`. Сигналинг служит только двум участникам одного сеанса (`sessionId`), без списков, комнат, регистраций имен или лишних этапов.

---

## 1. Общие положения

- Используется одно устойчивое соединение `wss://<host>/signal`, которое устанавливает `HomeCall_Web_Net_SignalClient$` при переходе в `call`.
- Сервер маршрутизирует сообщения по полю `sessionId`: веб-клиенты не регистрируются в комнатах или списках, а просто обмениваются SDP/ICE внутри единого идентификатора.
- Все сообщения подписываются и логируются (`HomeCall_Web_Shared_Logger$`), чтобы можно было отследить, какие события приходят по конкретному сеансу.

---

## 2. Форматы сообщений

| Тип            | Откуда → Кому                      | Поля                                    | Назначение                           |
| -------------- | ---------------------------------- | --------------------------------------- | ------------------------------------ |
| `"offer"`      | инициатор → сигналинг → получатель | `sessionId`, `from`, `sdp`              | Передача SDP-предложения             |
| `"answer"`     | получатель → сигналинг → инициатор | `sessionId`, `from`, `sdp`              | Ответ на предложение                 |
| `"candidate"`  | любой участник → сигналинг → другой | `sessionId`, `from`, `candidate`        | Обмен ICE-кандидатами                |
| `"error"`      | сервер → клиент                    | `sessionId`, `message`, `code?`         | Уведомление об ошибке сигналинга     |

Каждое сообщение содержит `sessionId`, позволяя серверу поддерживать FIFO-очереди SDP/ICE и гарантировать, что данные приходят именно участникам одного одноразового сеанса.

---

## 3. Поведение клиента

1. `HomeCall_Web_Core_App` генерирует `sessionId` при нажатии **«Позвонить»**, а `ShareLink` добавляет его в ссылку `/?session=<uuid>`.  
2. После нажатия **«Начать звонок»** `Net.startSignal(sessionId)` отправляет первые `offer`/`candidate`, а `Rtc.startOutgoingSession(sessionId)` прокидывает `onIceCandidate`.  
3. Получатель ссылки, открыв `?session=<uuid>`, получает `sessionId` из `Env`, сразу включает `Media.prepare()`, начинает `Net.startSignal(sessionId)` и ждёт `offer`, чтобы отправить `answer`.  
4. Любые повторные подключения используют тот же `sessionId`; если второй участник ещё не пришёл, `offer`/`candidate` сохраняются на сервере и доставляются при появлении клиента.
5. В случае разрыва `Core` вызывает `Net.stopSignal()`, сервер очищает очередь по `sessionId`, а `call` возвращается в `end`.

---

## 4. Принципы реализации

- Сервер не знает ни имён, ни комнат: он просто сопоставляет `sessionId` с двумя активными сокетами.  
- `sessionId` фиксирован в пределах жизненного цикла звонка; после завершения сеанса он больше не используется.  
- `HomeCall_Web_Shared_Logger$` логирует `sessionId` во всех сообщениях, чтобы отладка проходила без пользовательских атрибутов.
- Клиенты не отправляют отдельных команд `join`/`leave` — информация о присутствии уже учтена на уровне WebRTC и `sessionId`.

---

## 5. Безопасность

- Подключения проходят только по `wss://`.  
- Сервер проверяет `sessionId` на соответствие активному сеансу и игнорирует входящие сообщения, если `sessionId` устарел или завершён.  
- Любые `error`-сообщения с `sessionId` приходят с понятным текстом (`"Сессия завершена"`, `"Сигнал не найден"`) для отображения в тостах.

---

## 6. Связи

- `ctx/rules/web/contours/net.md` — API `Net` оборачивает JSON-сообщения.  
- `ctx/rules/web/contours/core.md` — `Core` рассылает команды `startSignal(sessionId)`/`stopSignal()`.  
- `ctx/rules/web/contours/env.md` — `Env` извлекает `session` из URL и передаёт его через DI.  
- `ctx/rules/web/infra/pwa.md` — PWA-агенты могут инициировать `CacheCleaner`, чтобы после обновления очистить очереди по `sessionId`.

---

## Итог

Протокол сигналинга сфокусирован на одном `sessionId` и двух участниках. Он исключает хранение имён, комнат и списков — вместо этого упирается в одноразовый идентификатор и предсказуемый обмен SDP/ICE.
