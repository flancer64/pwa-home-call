# Правила модульного тестирования Web-компонентов (ctx/rules/web/testing.md)

## Назначение

Документ определяет правила модульного тестирования **браузерной части** проекта **HomeCall**.  
Он уточняет рамочные принципы из `ctx/rules/arch/testing.md`, описывая подход к изоляции, организации и выполнению тестов для фронтенд-компонентов, исполняемых в среде браузера.

---

## Область применения

Правила распространяются на тесты, проверяющие работу клиентской логики приложения, включая:

- ядро (`HomeCall_Web_Core_*`);
- пользовательский интерфейс (`HomeCall_Web_Ui_*`);
- управление медиа и сетью (`HomeCall_Web_Media_*`, `HomeCall_Web_Net_*`);
- вспомогательные компоненты (`HomeCall_Web_Pwa_*`, `HomeCall_Web_Shared_*`).

Все тесты выполняются в Node.js, где браузерная среда эмулируется с помощью мок-объектов (`window`, `document`, `navigator`, `MediaStream` и др.).  
Задача тестов — проверить корректность публичного поведения модулей без обращения к реальному DOM и устройствам.

---

## Структура каталогов

```text
project-root/
├── web/
│   └── app/
│       ├── Core/
│       ├── Media/
│       ├── Ui/
│       └── Pwa/
└── test/
    └── web/
        ├── helper.mjs
        ├── app/
        │   ├── Core/
        │   │   ├── App.test.mjs
        │   │   └── UiController.test.mjs
        │   ├── Media/
        │   │   └── Manager.test.mjs
        │   ├── Pwa/
        │   │   └── CacheCleaner.test.mjs
        │   └── Ui/
        │       └── Enter.test.mjs
```

Каждый модуль из `web/app/...` имеет зеркальный тест в `test/web/app/...`.

---

## Инициализация контейнера

Для создания DI-контейнера используется общий _helper_ `test/web/helper.mjs`, обеспечивающий независимость тестов:

```js
import { createWebContainer } from "../helper.mjs";
const container = await createWebContainer();
const app = await container.get("HomeCall_Web_Core_App$");
```

Особенности:

- контейнер загружается из `@teqfw/di` (через CDN или локально);
- корневой namespace добавляется как `HomeCall_Web_`;
- каждый тест запускается в новом контейнере;
- все моки регистрируются только через `container.register()`.

Прямые импорты исходных файлов не допускаются.

---

## Организация тестов

- Каждый модуль тестируется по его **публичному API** (методы `run`, `show`, `prepare` и т.п.).
- Для эмуляции браузерной среды создаются stub-объекты:

  - `window`, `document`, `navigator`, `MediaStream`, `FormData`;
  - DOM-элементы с методами `addEventListener`, `querySelector`, `classList`, `hidden`, `textContent`.

- Тесты моделируют реальные пользовательские сценарии:

  - нажатие кнопок, отправку форм, события `click` и `submit`;
  - обновление интерфейса (изменение свойств DOM-элементов);
  - работу с mock-медиа (`getUserMedia`, `enumerateDevices`);
  - сетевое взаимодействие (`SignalClient`, `ServiceWorkerManager`, `CacheCleaner`).

- Каждый тест изолирован, использует собственный контейнер и очищает глобальные объекты (`MediaStream`, `FormData`, `caches`) в `finally`.

---

## Инструменты

- Среда выполнения: **Node.js**
- Библиотеки: встроенные `node:test` и `node:assert/strict`
- Тесты выполняются через npm-скрипт:

```bash
npm run test:web
```

- Все тесты должны быть идемпотентны и не влиять на внешнюю систему.
- Сообщения, имена тестов и логи — на английском языке.
- При необходимости имитации временных эффектов допускается использование stub-функций (`setTimeout`, `setInterval`).

---

## Контроль согласованности

1. Каждый публичный модуль интерфейса должен иметь зеркальный тест.
2. Изменения в UI или логике взаимодействия требуют обновления тестов.
3. Ошибки при `npm run test:web` трактуются как нарушение согласованности веб-контекста.
4. Тесты должны подтверждать:

   - корректную инициализацию контейнера;
   - обработку событий и взаимодействие экранов;
   - правильное управление медиа и WebSocket-подключениями;
   - отсутствие утечек состояния между тестами.

---

## Принципы проектирования тестов

- **Изоляция:** каждый тест создаёт свой контейнер и окружение.
- **Контрактность:** проверяется только публичное поведение модулей.
- **Репрезентативность:** тест имитирует реальные пользовательские сценарии.
- **Идемпотентность:** повторный запуск не изменяет состояние.
- **Читаемость:** тест читается как спецификация поведения интерфейса.

---

## Ссылки

- `ctx/rules/arch/testing.md` — рамочные принципы тестирования.
- `ctx/rules/node/testing.md` — правила тестирования Node-компонентов.
- `ctx/rules/arch/di.md` — архитектура контейнера зависимостей `@teqfw/di`.

---

## Итог

Документ устанавливает единообразные принципы тестирования веб-компонентов **HomeCall**.
Он гарантирует изоляцию, контрактность и репрезентативность тестов при эмуляции браузерной среды.
Эти правила обеспечивают целостность и предсказуемость поведения фронтенд-части приложения.
