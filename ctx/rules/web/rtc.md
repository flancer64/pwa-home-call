# Взаимодействие WebRTC в HomeCall (`ctx/rules/web/rtc.md`)

## Назначение

Документ определяет архитектурные принципы работы **WebRTC** во фронтенд-части HomeCall.  
Цель — зафиксировать минимальный набор ролей и этапов соединения между пользователями без описания конкретной реализации.

---

## 1. Общие положения

- WebRTC обеспечивает прямое соединение между двумя браузерами.
- Сигналинг выполняется через **WebSocket**-канал (`ws/client.js`).
- Все операции производятся внутри PWA и не требуют сторонних сервисов.
- Обмен аудио/видео потоками идёт напрямую между клиентами, без прокси на сервере.

---

## 2. Основные компоненты

| Модуль         | Назначение                                               |
| -------------- | -------------------------------------------------------- |
| `rtc/peer.js`  | Создаёт и управляет объектом `RTCPeerConnection`.        |
| `ws/client.js` | Отправляет и получает SDP/ICE-сообщения через WebSocket. |
| `app.js`       | Координирует состояния соединения и интерфейса.          |

---

## 3. Этапы соединения

1. **Инициализация:** пользователь выбирает собеседника → создаётся `RTCPeerConnection`.
2. **Offer:** инициатор вызывает `createOffer()`, отправляет SDP через WebSocket.
3. **Answer:** принимающая сторона вызывает `createAnswer()` и возвращает SDP.
4. **ICE:** обе стороны обмениваются ICE-кандидатами.
5. **Media:** при успешном обмене начинается передача аудио/видео потоков.
6. **Завершение:** при разрыве вызова соединение и медиа-потоки корректно закрываются.

---

## 4. Принципы работы

- Используется только **один** активный `RTCPeerConnection` на сеанс.
- Медиа-потоки (`MediaStream`) запрашиваются через `getUserMedia()`.
- Разрешения (камера, микрофон) запрашиваются при первом вызове.
- Вся логика сигналинга изолирована от UI; обмен событиями идёт через события приложения.
- Ошибки и события (`oniceconnectionstatechange`, `ontrack`, `onerror`) логируются через встроенный логгер.
- Состояния соединения должны быть синхронизированы с экраном интерфейса (`ui/screens.md`).

---

## 5. Безопасность и ограничения

- Соединение доступно только через HTTPS.
- Передача медиа ведётся по SRTP (встроено в WebRTC).
- ICE-кандидаты ограничиваются STUN; TURN можно добавить позже.
- Сигналинг не хранит личные данные, только технические параметры сеанса.

---

## 6. Связи

- `../arch/front.md` — архитектура фронтенда.
- `./structure.md` — размещение файлов `rtc/` и `ws/`.
- `./pwa.md` — ограничения офлайн-режима.
- `./ui/screens.md` — отображение состояний вызова.

---

## Итог

Документ задаёт основу работы WebRTC в HomeCall:  
взаимодействие происходит через WebSocket-сигналинг, соединение устанавливается напрямую между клиентами, а управление состояниями выполняется внутри приложения без внешних зависимостей.  
Эта модель обеспечивает простоту, автономность и прозрачность реализации видеосвязи 1-на-1.
