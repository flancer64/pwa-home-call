# Взаимодействие WebRTC в HomeCall (`ctx/rules/web/rtc.md`)

## Назначение

Документ фиксирует принципы функционирования **WebRTC** во фронтенд-части HomeCall как элемента архитектуры обмена медиаданными.  
Он описывает состав компонентов, последовательность взаимодействия и поведение системы при различных конфигурациях устройств ввода, не указывая процедур реализации.

---

## 1. Общие положения

WebRTC обеспечивает прямое медиасоединение между двумя браузерами внутри PWA-приложения.  
Сигналинг выполняется через канал **WebSocket** (`ws/client.js`).  
Передача аудио- и видеопотоков происходит напрямую между клиентами без участия сервера.  
Все процессы выполняются в браузере и не требуют внешних сервисов.

---

## 2. Основные компоненты

| Модуль         | Назначение                                              |
| -------------- | ------------------------------------------------------- |
| `rtc/peer.js`  | Управляет объектом `RTCPeerConnection`.                 |
| `ws/client.js` | Передаёт и принимает SDP/ICE-сообщения через WebSocket. |
| `app.js`       | Согласует состояния соединения и интерфейса.            |

---

## 3. Этапы соединения

1. Пользователь выбирает собеседника, создаётся `RTCPeerConnection`.
2. Инициатор формирует `offer`, принимающая сторона — `answer`.
3. Стороны обмениваются ICE-кандидатами.
4. При успешном обмене активируется передача медиапотоков.
5. После завершения вызова соединение корректно закрывается.

---

## 4. Поведение системы

Сессия содержит один активный `RTCPeerConnection`.  
Разрешения на использование устройств запрашиваются при первом обращении.  
Сигналинг изолирован от интерфейса, события маршрутизируются через внутренние механизмы приложения.  
Ошибки и переходы состояний логируются, а отображение синхронизируется с экранами `ui/screens.md`.

---

## 5. Безопасность и ограничения

Соединение доступно только через HTTPS.  
Передача медиа ведётся по SRTP (встроено в WebRTC).  
Используются ICE-кандидаты STUN; добавление TURN допускается позднее.  
Сигналинг не сохраняет личные данные, обрабатываются лишь технические параметры сеанса.

---

## 6. Адаптация к медиа-возможностям устройства

Фронтенд HomeCall автоматически определяет доступные аудио- и видеоустройства при инициализации.  
Работа корректна при любом их сочетании:

- при наличии камеры и микрофона устанавливается двухпоточный режим (аудио + видео);
- при отсутствии камеры — только аудио;
- при отсутствии микрофона — только видео;
- при полном отсутствии устройств выполняется соединение без медиа, ограниченное сигналингом.

Выбранная конфигурация фиксируется логгером как информационное сообщение.  
Интерфейс отражает активные потоки и сохраняет устойчивость при изменении их набора во время сеанса.

---

## 7. Связи

- `../arch/front.md` — архитектура фронтенда;
- `./structure.md` — размещение файлов `rtc/` и `ws/`;
- `./pwa.md` — ограничения офлайн-режима;
- `./ui/screens.md` — отображение состояний вызова.

---

## Итог

WebRTC в HomeCall реализует автономное, безопасное и адаптивное соединение между пользователями через WebSocket-сигналинг.  
Система сохраняет функциональность при любых аппаратных конфигурациях и обеспечивает единое поведение приложения без внешних зависимостей.
