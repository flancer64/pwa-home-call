# Контур Env и абстракция окружения (`ctx/rules/web/env.md`)

## Назначение

`HomeCall_Web_Env_Provider$` описывает переменные окружения, флаги и особенности платформы, необходимые остальным контурам. Env служит источником конфигурации, распознаёт возможности браузера и предоставляет адаптеры для браузерного и тестового запуска.

## Границы и интерфейсы

- **Вход**: данные из `.env`, `navigator`, `window`, агентские подстановки (например, Codex-Agent при тестах в Node.js) через DI.
- **Выход**: объекты `Env.Context` и события `env:change`, `env:ready`, предоставляемые `Shared.EventBus`, а также синхронные коллбэки `env.get`, `env.on`.
- **Соглашения**: Core, Media и Net запрашивают `Env` только через контейнер, не используя глобальные переменные напрямую. При смене состояния (например, `NODE_ENV` → `production`) Env публикует событие `env:change` на шине.

## Типичные DI-зависимости

- `HomeCall_Web_Env_Provider$`
- `HomeCall_Web_Env_Platform$`
- `HomeCall_Web_Env_Features$`
- `HomeCall_Web_Shared_EventBus$`
- `HomeCall_Web_Shared_Logger$`

## Контейнер и позднее связывание

Env зарегистрирован в `@teqfw/di` как `HomeCall_Web_Env_Provider$`; агенты и тесты подменяют эту реализацию, чтобы управлять параметрами запуска (например, задают фиктивный `host`, `room`, `wsPort`). Env отдаёт только интерфейсы, зарегистрированные в контейнере, и сигнализирует о смене настроек через `Shared.EventBus`. Для запуска браузерной и Headless-среды используется одна и та же регистрация, но разные фабрики конфигурации.

## Связи

- `ctx/rules/web/core.md` — Core опрашивает Env перед запуском состояний.
- `ctx/rules/web/media.md` — Media получает разрешения через Env (например, `env.permissions.media`).
- `ctx/rules/web/net.md` — Net использует Env для построения URL `wss://`.
- `ctx/rules/web/shared.md` — EventBus и логгер Env делит с остальными.
