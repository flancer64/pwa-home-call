# Прогрессивное веб-приложение HomeCall

Этот документ конкретизирует раздел **«Поведение PWA»** из `app.md`, описывая актуальную архитектуру автономности, кэширования и обновления версии браузерного приложения HomeCall.

---

## Назначение

Документ фиксирует принципы реализации **PWA-режима** для HomeCall.  
Главная цель — обеспечить **полный запуск приложения при отсутствии сети**, включая загрузку DI-контейнера и всех зависимостей, чтобы пользователь всегда видел понятное состояние интерфейса.

---

## 1. Компоненты PWA

- **`manifest.json`** — стандартный манифест приложения:

  - `name`, `short_name`, `description`;
  - `start_url` = `"./index.html"`;
  - `display` = `"standalone"`;
  - `background_color`, `theme_color`;
  - иконки в `assets/icons/` (размеры 192×192 и 512×512).

- **`version.json`** — версия сборки; обновляется сервером при каждой публикации. Используется для формирования имени кэша.

- **`service-worker.js`** — управляет кэшированием и офлайн-режимом:
  - кэширует все исходные модули (`web/app/**/*.mjs`);
  - кэширует основные HTML-, CSS- и статические ресурсы;
  - удаляет устаревшие кэши при обновлении версии;
  - обрабатывает `install`, `activate`, `fetch`, `message`.

---

## 2. Состав кэша сервис-воркера

### Core-кэш (предзагрузка при установке)

Кэшируются все файлы, необходимые для автономного запуска:

| Каталог / Тип файлов | Назначение                                                                                                                                                |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `/index.html`        | Точка входа приложения                                                                                                                                    |
| `/app.js`            | Инициализация DI-контейнера                                                                                                                               |
| `/manifest.json`     | Манифест PWA                                                                                                                                              |
| `/assets/style.css`  | Базовые стили интерфейса                                                                                                                                  |
| `/assets/icons/`     | Иконки для ярлыков                                                                                                                                        |
| `/ui/*.html`         | Шаблоны экранов (`enter`, `lobby`, `call`, `end`)                                                                                                         |
| `/app/**/*.mjs`      | **Все модули фронтенда HomeCall**, включая Core, Ui, Shared, Env, Media, Net, Rtc — чтобы DI-контейнер мог разрешить все зависимости и запуститься офлайн |

> Этот принцип гарантирует, что даже при потере соединения контейнер зависимостей `@teqfw/di` сможет загрузить все классы и восстановить работу приложения до уровня UI.

### Исключения

Не кэшируются данные, связанные с сетью или мультимедиа, если они запрашиваются во время работы:

- WebSocket-соединения (`/signal`, `/ws/`);
- медиапотоки (`getUserMedia`);
- любые внешние HTTP-запросы и API.

---

## 3. Поведение сервис-воркера

1. **Установка (`install`)**

   - получает версию из `version.json`;
   - создаёт кэш `homecall-v{номер}`;
   - сохраняет все указанные файлы.
   - вызывает `skipWaiting()` для немедленной активации.

2. **Активация (`activate`)**

   - удаляет старые кэши, не совпадающие по версии;
   - вызывает `clients.claim()` для управления страницами.

3. **Обновление (`version check`)**

   - модуль `VersionWatcher` периодически проверяет `version.json`;
   - при изменении версии отправляет сообщение `"skip-waiting"` воркеру.

4. **Запросы (`fetch`)**

   - `version.json` — всегда из сети (`no-store`);
   - для `navigate` запросов — стратегия _network-first_ с fallback на `index.html`;
   - для файлов из core-кэша — _cache-first_;
   - все остальные запросы — напрямую в сеть.

5. **Сообщения (`message`)**
   - `"skip-waiting"` — немедленная активация новой версии.

---

## 4. Принципы реализации

- Кэш именуется `homecall-v{version}`.
- Кэш обновляется полностью при изменении `version.json`.
- В кэше всегда присутствует полный набор `.mjs`-файлов из `web/app/`.
- При офлайн-запуске приложение полностью стартует, показывает UI и информирует пользователя об отсутствии сети.
- Медиа- и сетевые функции могут не работать, но пользователь получает стабильный интерфейс и сообщения об ошибках.

---

## Связи

- `./app.md` — сценарии поведения приложения.
- `../arch/front.md` — архитектура фронтенда.
- `./structure.md` — файловая организация.
- `./core.md`, `./ui.md`, `./shared.md`, `./env.md` — контуры, поддерживаемые офлайн.
- `./net.md`, `./rtc.md`, `./media.md` — модули, зависимые от сети, но включённые в кэш для разрешения DI.

---

## Итог

PWA-архитектура HomeCall теперь обеспечивает **полный офлайн-запуск**:  
все `.mjs`-модули приложения кэшируются, DI-контейнер загружается без сети, а пользователь видит предсказуемое состояние интерфейса.  
Сервис-воркер управляет версиями, обновлением и очисткой кэша, обеспечивая устойчивость приложения при любых сетевых сбоях.

См. также `app.md` — обзорный документ браузерного приложения HomeCall.
