# Прогрессивное веб-приложение HomeCall

Документ конкретизирует раздел **«Поведение PWA»** из `app.md`, описывая архитектуру автономности, кэширования и обновления браузерного приложения HomeCall.

---

## Назначение

Цель — обеспечить **полный офлайн-запуск** и **автоматическое обновление** фронтенда при публикации новой версии.  
Пользователь всегда взаимодействует с актуальной сборкой, а приложение устойчиво при потере сети.

---

## 1. Компоненты PWA

- **`manifest.json`** — стандартный манифест (`name`, `start_url`, `display`, `icons`).
- **`version.json`** — источник истины о версии сборки; обновляется при публикации.
- **`service-worker.js`** — управляет кэшированием и офлайн-режимом:
  - кэширует все `.mjs`-модули (`web/app/**/*.mjs`) и базовые ресурсы;
  - удаляет устаревшие кэши при смене версии;
  - обрабатывает `install`, `activate`, `fetch`, `message`.

---

## 2. Состав кэша

### Core-кэш

Включает всё, что нужно для автономного запуска DI-контейнера:

| Тип                                                     | Назначение                             |
| ------------------------------------------------------- | -------------------------------------- |
| `/index.html`, `/app.js`                                | Точка входа и инициализация контейнера |
| `/manifest.json`, `/assets/style.css`, `/assets/icons/` | PWA и UI-ресурсы                       |
| `/ui/*.html`                                            | Шаблоны экранов                        |
| `/app/**/*.mjs`                                         | Все модули фронтенда HomeCall          |

> DI-контейнер `@teqfw/di` должен разрешить зависимости и запустить интерфейс офлайн.

### Исключения

Не кэшируются медиапотоки, WebSocket-соединения и внешние HTTP-запросы.

---

## 3. Поведение сервис-воркера

1. **Установка (`install`)** — получает версию из `version.json`, создаёт кэш `homecall-v{version}`, активирует сразу (`skipWaiting()`).
2. **Активация (`activate`)** — удаляет старые кэши, вызывает `clients.claim()`.
3. **Обновление (`version check`)** — `VersionWatcher` проверяет `/version.json`, при изменении сообщает воркеру `"skip-waiting"`.
4. **Запросы (`fetch`)** —
   - `version.json` — всегда из сети;
   - `navigate` — _network-first_;
   - core-кэш — _cache-first_;
   - прочее — напрямую в сеть.
5. **Сообщения (`message`)** — `"skip-waiting"` вызывает немедленное обновление.

---

## 4. Версионность и обновление

### Принцип

Версия фронтенда — часть архитектуры, управляющая жизненным циклом PWA.

### Декларация

- **Файл `web/version.json`** содержит UTC-timestamp (`YYYYMMDD-HHMMSS`) и обновляется агентом при изменениях в `./web/` (см. `web/AGENTS.md`).
- **Имя кэша** формируется как `homecall-v{version}`; воркер удаляет все остальные версии.
- **Модуль `HomeCall_Web_Core_VersionWatcher`** периодически запрашивает `/version.json`; при расхождении значений инициирует обновление интерфейса и кэша.
- **Обновление** выполняется автоматически, без согласия пользователя; устаревшие ресурсы не используются.
- **Пользователь всегда работает с последней опубликованной версией.**

---

## 5. Очистка кэша вручную

Кнопка **«Очистить кэш»** в панели управления инициирует полный сброс локальных данных приложения:

- удаляются все записи из `caches` (`caches.delete('*')`);
- снимаются регистрации сервис-воркеров (`navigator.serviceWorker.getRegistrations()` → `unregister()`);
- выполняется `location.reload()` для перезапуска приложения и регистрации новой версии воркера.

Эта кнопка является единственным ручным инструментом обновления PWA.

---

## Итог

PWA HomeCall обеспечивает офлайн-запуск, предсказуемое обновление и синхронизацию версий.  
`service-worker.js`, `VersionWatcher` и `CacheCleaner` действуют в единой архитектурной схеме, гарантируя, что пользователь всегда работает с актуальной сборкой.
