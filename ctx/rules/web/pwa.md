# Прогрессивное веб-приложение HomeCall

Документ определяет декларативную архитектуру прогрессивного веб-приложения (PWA) HomeCall.  
Его цель — зафиксировать предсказуемое поведение автономности, кэширования и версионности фронтенда, чтобы обеспечить устойчивость работы независимо от сети и согласованность между пользователем, сервис-воркером и когнитивным контуром проекта.

---

## 1. Назначение

Система PWA HomeCall обеспечивает:

- запуск без сети при доступности ранее загруженной сборки;
- автоматическое обновление при публикации новой версии;
- полное соответствие кэша актуальному состоянию сборки;
- детерминированное поведение при смене версии и ручном сбросе.

---

## 2. Состав компонентов

| Компонент                              | Назначение                                                                       |
| -------------------------------------- | -------------------------------------------------------------------------------- |
| **`manifest.json`**                    | декларация метаданных PWA (имя, иконки, режим отображения, точка входа);         |
| **`version.json`**                     | источник истины о версии фронтенда в формате UTC-timestamp (`YYYYMMDD-HHMMSS`);  |
| **`service-worker.js`**                | управляющий агент, обеспечивающий кэширование, автономность и обновление версий; |
| **`HomeCall_Web_Core_VersionWatcher`** | наблюдатель, синхронизирующий состояние приложения с актуальной версией;         |
| **`HomeCall_Web_Pwa_CacheCleaner`**    | инструмент ручной очистки кэшей и повторной установки воркера.                   |

---

## 3. Принципы автономности

1. Кэш браузера хранит полное множество файлов, необходимых для работы DI-контейнера `@teqfw/di` в офлайн-режиме.  
   В кэш включаются все `.mjs`-модули приложения, шаблоны экранов, манифест и ресурсы интерфейса.

2. Медиа-потоки, WebSocket-соединения и внешние запросы не кэшируются и требуют подключения к сети.

3. Понятие «core-кэш» фиксирует минимальный набор ресурсов, при котором интерфейс доступен и управляем без сервера.

---

## 4. Версионность

1. Версия фронтенда — часть архитектуры, определяющая актуальность кэша.  
   Каждая версия идентифицируется значением из `web/version.json`.

2. Имя кэша определяется как `homecall-v{version}`.  
   Все иные кэши считаются устаревшими и подлежат удалению при активации новой версии.

3. Обновление версии является синхронным процессом:

   - файл `version.json` обновляется агентом при изменениях в `./web/`;
   - `VersionWatcher` получает актуальное значение с сервера и уведомляет сервис-воркер;
   - сервис-воркер проходит цикл установки и активации новой версии;
   - старые кэши удаляются до завершения активации;
   - приложение после активации отображает обновлённую сборку.

4. Процесс обновления не требует участия пользователя и выполняется прозрачно.  
   В любой момент пользователь работает только с последней опубликованной версией.

---

## 5. Роль сервис-воркера

1. Сервис-воркер поддерживает консистентность между версией приложения и состоянием кэша.  
   Его активация является границей между версиями.

2. При активации воркер:

   - определяет текущую версию по `version.json`;
   - удаляет все кэши, не совпадающие с `homecall-v{version}`;
   - фиксирует факт очистки в лог:

     ```text
     [ServiceWorker] Activated version {version}, old caches removed
     ```

3. Очистка кэша выполняется только сервис-воркером и считается частью цикла жизненного обновления.  
   Другие компоненты не вмешиваются в этот процесс.

4. При отсутствии сети воркер сохраняет последнюю активную версию и обслуживает запросы из кэша до следующей успешной синхронизации.

---

## 6. Поведение наблюдателя версии

1. `HomeCall_Web_Core_VersionWatcher` периодически проверяет `/version.json` с сервера.  
   Интервал проверки фиксирован в конфигурации окружения (`60 000 мс` по умолчанию).

2. При обнаружении расхождения версий наблюдатель инициирует активацию новой версии,  
   посылая сервис-воркеру сообщение `"skip-waiting"`.

3. Сам наблюдатель не управляет кэшами и не изменяет состояние хранилища.  
   Его роль — выявление новой версии и передача сигнала воркеру.

4. Факт смены версии отражается в логе уровня `info`:

```text
[VersionWatcher] Version change detected: {oldVersion} → {newVersion}
```

---

## 7. Ручная очистка кэша

1. Кнопка **«Очистить кэш»** доступна в панели управления приложения.  
   Её активация запускает модуль `HomeCall_Web_Pwa_CacheCleaner$`.

2. Ручная очистка выполняет:

- снятие регистраций всех сервис-воркеров;
- удаление всех кэшей из хранилища браузера;
- запись в лог уровня `info`:

```text
[CacheCleaner] PWA cache cleared and service worker reinstalled
```

- перезапуск страницы, инициирующий установку новой версии воркера.

3. Эта операция является единственным ручным инструментом восстановления и не заменяет автоматическую систему обновлений.

---

## 8. Логирование

Все действия, связанные с версиями и кэшами, фиксируются на уровне `info` стандартным клиентским логгером `HomeCall_Web_Core_Logger$`.  
Логи могут дублироваться в консоль и передаваться на сервер при включённом зеркалировании.

---

## 9. Инварианты системы

- Каждая версия фронтенда имеет собственный кэш и собственный воркер.
- Старые кэши не сохраняются после активации новой версии.
- `VersionWatcher` никогда не изменяет кэш напрямую.
- Очистка кэша выполняется только сервис-воркером (автоматически) или пользователем (через CacheCleaner).
- После каждой активации система находится в согласованном состоянии: версия, кэш и лог соответствуют друг другу.

---

## Итог

Архитектура PWA HomeCall обеспечивает предсказуемое, наблюдаемое и воспроизводимое поведение при изменении версии.  
Сервис-воркер управляет жизненным циклом кэша, наблюдатель контролирует актуальность версии, а логгер фиксирует все изменения.  
Эта декларация гарантирует, что приложение в любой момент отражает последнюю опубликованную сборку и сохраняет функциональность при отсутствии сети.
