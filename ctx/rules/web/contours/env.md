# Контур Env и абстракция окружения

Этот документ описывает контур **Env**, обеспечивающий браузерные параметры и конфигурацию для ДомоЗвона.

## Назначение

`HomeCall_Web_Env_Provider$` агрегирует переменные окружения, URL-параметры и платформенные флаги. Он предоставляет методы `getContext()` и `onChange(callback)`, которые вызываются напрямую `Core`, `Net` и `Ui` через DI без публикации событий на шине.

---

## Границы и интерфейсы

- **Вход**: глобальные объекты (`navigator`, `window`, `location`), `.env`, параметры из контейнера (`host`, `wsPort`, `room`), Codex-подмены в тестах.
- **Выход**:
  - `getContext()` возвращает настройки (`host`, `room`, `version`, `platform`, `permissions`);
  - `onChange(callback)` позволяет Core и Ui подписаться на обновления (например, при переходе из локальной разработки в прод);
  - `buildSignalUrl()` формирует `wss://`-строку для `Net`.

Env не генерирует событий `env:change` через EventBus — вместо этого он вызывает зарегистрированные коллбэки прямо из контейнера.

---

## Типичные DI-зависимости

- `HomeCall_Web_Env_Provider$`
- `HomeCall_Web_Env_Platform$`
- `HomeCall_Web_Env_Features$`
- `HomeCall_Web_Shared_Logger$`

Env инжектируется в Core, Media и Net; они обращаются к его методам без глобальных переменных.

---

## Контейнер и позднее связывание

Env регистрируется в `@teqfw/di` как `HomeCall_Web_Env_Provider$`. При запуске браузерной сборки он возвращает реальные значения, в тестах — моки. Поскольку взаимодействие построено через DI, другие контуры получают новые значения только после вызова `onChange` и не ждут промежуточной EventBus-шины.

---

## Связи

- `ctx/rules/web/app.md` — правильное отображение состояний `home` и `call` зависит от окружения.
- `ctx/rules/web/contours/core.md` — Core спрашивает `room` из Env перед генерацией комнаты.
- `ctx/rules/web/contours/net.md` — строит URL для WebSocket.
- `ctx/rules/web/contours/media.md` — проверяет разрешения (`permissions`) и платформенные ограничения.
- `ctx/rules/web/contours/shared.md` — логгер фиксирует изменения окружения.

---

## Итог

Env предоставляет прямые API для получения и обновления параметров окружения. Это соответствует архитектуре Tequila Framework без EventBus — все коллбэки регистрируются через DI и вызываются напрямую.
