# Контур Ui и экранная логика

Этот документ описывает контур **Ui**, являющийся частью браузерного приложения ДомоЗвон, определённого в `app.md`.

## Назначение

Ui — это экранная логика и визуальный оркестратор, который получает команды из Core и транслирует действия пользователя обратно через события. Документ фиксирует разграничение состояний (см. `ui/screens.md`), способы подачи уведомлений о разрешениях и реакцию на сетевые и медиасигналы.

Состояния интерфейса (`enter`, `invite`, `lobby`, `call`, `end`) совпадают со сценарными состояниями приложения, определёнными в `app.md`.
Экран `invite` активируется по действию инициатора «Поделиться ссылкой» (toolbar) и используется для формирования приглашения (ввод имени приглашённого и комнаты назначения). Получатель приглашения экран `invite` не видит: при открытии ссылки он попадает на `enter` с предзаполненными полями.

## Границы и интерфейсы

- **Входные события**: `core:state`, `core:ready`, `media:state`, `net:error`, `env:change` через `Shared.EventBus`; коллбэки `onScreenReady`, `onAction(userAction)` передаются из Core.
- **Выходные сигналы**: `ui:action:<type>` (например, `ui:action:initiate-call`, `ui:action:exit`, `ui:action:share-link`), `ui:navigate`, `ui:permission-request` через EventBus; синхронные ответы на Core (`ack`, `ready`).

`ui:action:share-link` — пользовательское действие инициатора: Core переводит интерфейс на `invite`, где инициатор вводит «имя приглашённого» и «комнату назначения»; затем Core формирует URL приглашения и вызывает Web Share API (или выполняет копирование ссылки).
- **Экранное поведение**: Ui сам обрабатывает внутренние коллбэки (кнопки, swipe-события) и не обращается непосредственно к Media, Net или Env; вместо этого она постит `ui:action` события и ждёт реакций от Core.

Дополнительно, toolbar предоставляет единственную ручную кнопку **«Очистить кэш»**, которая служит способом сбросить локальные кэши и сервис-воркеры при возникновении сбоев либо необходимости принудительно перезапустить приложение. Все ручные обновления проходят только через эту операцию, автоматическая схема PWA сохраняется.

## Типичные DI-зависимости

- `HomeCall_Web_Ui_ScreenFactory$`
- `HomeCall_Web_Ui_Renderer$`
- `HomeCall_Web_Ui_InputHandler$`
- `HomeCall_Web_Shared_EventBus$`
- `HomeCall_Web_Shared_Logger$`

## Контейнер и взаимодействия

Ui разрешается через `@teqfw/di` в момент инициализации Core. Никакие UI-модули не инстанцируются напрямую: все подписки и callbacks на `Shared.EventBus` происходят через зарегистрированные сервисы `HomeCall_Web_Ui_*`. Ui взаимодействует с Core по строго заданным интерфейсам, и все события проходят через контейнер, что позволяет агентам и тестам заменять UI-обработчики на фиктивные реализации.

## Связи

- `ctx/rules/web/app.md` — состояния приложений и экранный сценарий.
- `ctx/rules/web/ui/screens.md` — статусы и раскладки экранов.
- `ctx/rules/web/contours/core.md` — команды на переход в состояния и обработка `ui:action`.
- `ctx/rules/web/contours/media.md` — отображение состояния устройств (событие `media:state`).
- `ctx/rules/web/contours/shared.md` — EventBus и логгер, используемые для транслирования событий.
- `ctx/product/features/invite.md` — продуктовая функция приглашения и обмена ссылками.

## Итог

Контур Ui реализует экранную часть сценариев `enter → lobby → call → end`, согласованных в `app.md`.  
См. также `app.md` — обзорный документ браузерного приложения ДомоЗвон.
