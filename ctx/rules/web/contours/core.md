# Контур Core и оркестрация

Этот документ описывает контур **Core**, являющийся частью браузерного приложения ДомоЗвон, определённого в `app.md`.

## Назначение

`HomeCall_Web_Core_App$` — единая точка оркестрации фронтенда.  
Core управляет жизненным циклом приложения, фиксирует переходы между состояниями, концентрирует внутриконтурные коллбэки и инициирует события в `Shared.EventBus`.  
Он не содержит бизнес-логики, а обеспечивает согласованность взаимодействий между контурами `Ui`, `Net`, `Media`, `Env` и `Infra`.

---

## Границы и интерфейсы

- **Входные воздействия:**

  - сигналы от `Env.Provider` (изменение окружения);
  - события от `Net` (изменение статуса соединения);
  - уведомления `Media` (готовность устройств);
  - пользовательские действия `Ui` (`ui:action`, включая `ui:action:share-link`).

- **Выходные сигналы:**
  - события `core:state`, `core:ready`, `core:shutdown` в `Shared.EventBus`;
  - команды `Ui` для переключения экранов (`enter`, `lobby`, `call`, `end`, `invite`);
  - запросы к `Net` (подключение, отключение, переподключение);
  - команды `Media` (старт и стоп потоков);
  - уведомления `Ui.Toast` о статусах (успешная отправка, отмена, ошибка).

---

## Оркестрационные сценарии

### Основной поток

Маршруты состояний базируются на схеме:  
`enter → lobby → call → end → lobby`.

Core управляет этими переходами, сверяя состояние систем (`Env`, `Net`, `Media`) и команды UI, чтобы обеспечивать корректную смену экранов и устойчивость соединения.

### Ветвь приглашения

Экран `invite` не входит в основной поток, но доступен как вспомогательная ветка.  
Сценарий активируется действием `ui:action:share-link` из меню или toolbar и не влияет на состояние активного соединения.

- Core получает сигнал `ui:action:share-link`;
- фиксирует текущие значения `room` и `name` из контекста;
- открывает экран `invite` с предзаполненными параметрами;
- после подтверждения (`invite:confirm`) генерирует ссылку и запускает `navigator.share()` или fallback-копирование;
- результат действия отображается через `HomeCall_Web_Ui_Toast`;
- после завершения (`invite:confirm` или `invite:cancel`) Core возвращает UI в предыдущее состояние.

URL-параметры (`room`, `name`) **не инициируют** переход в `invite` —  
они обрабатываются на уровне `enter` и синхронизируются с локальным хранилищем (`HomeCall_Web_Infra_Storage`).

---

## События

| Событие                | Обработка                                                                                                                                                                |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `ui:action:share-link` | Core открывает экран `invite`, передаёт текущие `room` и `name`, переводит приложение во вспомогательный режим «формирование ссылки».                                    |
| `invite:confirm`       | Core получает окончательные значения, создаёт ссылку, вызывает `navigator.share` или копирует в буфер, уведомляет через `Ui.Toast` и возвращает UI в исходное состояние. |
| `invite:cancel`        | Core закрывает экран `invite` и возвращает пользователя в предыдущее состояние без генерации ссылки.                                                                     |

---

## Типичные DI-зависимости

- `HomeCall_Web_Core_App$`
- `HomeCall_Web_Core_StateMachine$`
- `HomeCall_Web_Shared_EventBus$`
- `HomeCall_Web_Shared_Logger$`
- `HomeCall_Web_Env_Provider$`
- `HomeCall_Web_Ui_ScreenFactory$`
- `HomeCall_Web_Net_SignalClient$`
- `HomeCall_Web_Media_DeviceManager$`

---

## Контейнер и взаимодействия

Core получает все зависимости через `@teqfw/di`;  
никакие прямые `import`-зависимости между контурами не разрешены.  
Контейнер обеспечивает позднее связывание и позволяет подменять реализации для тестов или изолированных окружений.  
Core регистрирует собственные состояния и события в контейнере, чтобы другие контуры могли подписываться на них.

---

## Связи

- `ctx/rules/web/app.md` — сценарии состояний и вызовы `core:state`.
- `ctx/rules/web/contours/ui.md` — команды управления экранами.
- `ctx/rules/web/contours/net.md` — сетевые сигналы и статусы.
- `ctx/rules/web/contours/media.md` — управление устройствами.
- `ctx/rules/web/contours/env.md` — контекст окружения.
- `ctx/rules/web/contours/shared.md` — EventBus и логгер.
- `ctx/rules/web/ui/screens/invite.md` — инициаторский экран формирования приглашения.
- `ctx/rules/web/infra/storage.md` — хранилище, используемое для начальных параметров на экране `enter`.

---

## Итог

Контур **Core** — это механизм оркестрации браузерного приложения ДомоЗвон.  
Он объединяет события разных подсистем, управляет переходами состояний и обеспечивает корректное поведение приложения, включая вспомогательную ветку приглашения (`invite`) без нарушения основного пользовательского потока.
