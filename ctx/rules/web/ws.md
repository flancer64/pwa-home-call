# Протокол сигналинга WebSocket (`ctx/rules/web/ws.md`)

## Назначение

Документ фиксирует принципы и формат обмена данными через **WebSocket** во фронтенде **HomeCall**.  
Цель — описать структуру сообщений и поведение клиента при установлении, поддержке и завершении соединения для WebRTC-сессий.

---

## 1. Общие положения

- WebSocket используется как **канал сигналинга** для обмена SDP и ICE-кандидатами.
- Соединение устанавливается один раз при запуске приложения и используется для всех событий.
- Транспорт — JSON-сообщения в текстовом формате UTF-8.
- WebSocket-клиент реализован в `ws/client.js`.

---

## 2. Форматы сообщений

| Тип           | Направление                  | Поля                      | Назначение                             |
| ------------- | ---------------------------- | ------------------------- | -------------------------------------- |
| `"offer"`     | клиент → сервер → получатель | `from`, `to`, `sdp`       | передача SDP-предложения от инициатора |
| `"answer"`    | клиент → сервер → получатель | `from`, `to`, `sdp`       | ответ на предложение                   |
| `"candidate"` | клиент ↔ сервер ↔ получатель | `from`, `to`, `candidate` | обмен ICE-кандидатами                  |
| `"online"`    | сервер → все клиенты         | `users`                   | список активных пользователей          |
| `"join"`      | клиент → сервер              | `room`, `user`            | вход в комнату (по кодовому слову)     |
| `"leave"`     | клиент → сервер              | `room`, `user`            | выход из комнаты                       |
| `"error"`     | сервер → клиент              | `message`                 | сообщение об ошибке соединения         |

Все сообщения сериализуются в JSON и передаются через одно соединение.

---

## 3. Поведение клиента

1. При запуске `app.js` создаёт соединение с сервером `wss://<host>/signal/`.
2. После открытия клиент отправляет сообщение `"join"`.
3. При получении `"online"` обновляет список доступных пользователей.
4. При получении `"offer"`, `"answer"`, `"candidate"` передаёт данные в модуль `rtc/peer.js`.
5. При закрытии соединения или ошибке инициирует переподключение.
6. Все события логируются через встроенный логгер.

---

## 4. Принципы реализации

- Сервер не изменяет содержимое полей `sdp` и `candidate`, лишь маршрутизирует их.
- Передача сообщений идёт только между участниками одной комнаты.
- Повторное соединение должно быть идемпотентным (повтор `"join"` допустим).
- Обновление списка `users` должно вызываться при каждом входе/выходе клиента.
- Ошибки не хранятся и не ретранслируются.

---

## 5. Безопасность

- Соединение только через `wss://` (TLS).
- Сервер не хранит историю сигналов.
- Проверка кодового слова выполняется на сервере до разрешения `"join"`.
- Сообщения от неизвестных пользователей игнорируются.

---

## 6. Связи

- `./rtc.md` — использование сигналинга для WebRTC.
- `./app.md` — управление подключением и событиями.
- `../arch/front.md` — архитектура фронтенда.
- `./structure.md` — размещение файла `ws/client.js`.

---

## Итог

WebSocket-протокол HomeCall обеспечивает минимальный, прозрачный и безопасный канал сигналинга для установления WebRTC-соединений.  
Его структура фиксирована, не содержит бизнес-логики и гарантирует совместимость клиентов без дополнительных зависимостей.
