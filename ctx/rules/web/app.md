# Центральный модуль приложения (`ctx/rules/web/app.md`)

## Назначение

Документ определяет роль и обязанности главного модуля фронтенда **HomeCall** — файла `app.js`.  
Цель — зафиксировать его функции как координатора состояния приложения, обеспечивающего корректное взаимодействие пользователя с интерфейсом и устройствами (камера, микрофон).

---

## 1. Роль

- `app.js` — единая точка входа для клиентского кода.
- Управляет жизненным циклом приложения и состояниями экранов:  
  **вход → лобби → звонок → завершение**.
- Инициализирует и связывает внутренние модули:
  - `ws/client.js` — сигналинг по WebSocket;
  - `rtc/peer.js` — создание и управление WebRTC-соединением;
  - `ui/` — шаблоны экранов и элементы интерфейса;
  - `service-worker.js` — регистрация и обновление кеша.

---

## 2. Принципы работы

- При загрузке `app.js` регистрирует `service-worker.js` и подключается к серверу сигналинга.
- После успешного подключения отображает экран `lobby` с онлайн-списком.
- При выборе собеседника инициирует процесс установления WebRTC-сессии.
- При завершении или ошибке возвращает пользователя к экрану `lobby`.
- Все переходы реализуются через внутреннее состояние и обновление DOM, без перезагрузки страницы.
- Используется только нативный JavaScript (без фреймворков).

---

## 3. Состояния приложения

| Состояние | Назначение                                         |
| --------- | -------------------------------------------------- |
| `enter`   | ввод кодового слова комнаты и вход в систему       |
| `lobby`   | отображение списка пользователей и ожидание вызова |
| `call`    | активное соединение WebRTC                         |
| `end`     | завершение вызова, возврат к лобби                 |

Смена состояний управляется функцией `setState(name)` и обработчиками событий.

---

## 4. Требования

- Логика событий изолирована от визуальной части.
- Сетевые вызовы и обработчики ошибок делегируются модулям `ws/` и `rtc/`.
- Код читаем, документирован и использует только ES6+.
- Все комментарии и сообщения — на английском языке.
- Обработка ошибок WebRTC и медиаустройств должна быть пользовательски понятной.

---

## 5. UX разрешений камеры и микрофона

Для повышения прозрачности и удобства первого взаимодействия с приложением необходимо соблюдать следующие правила:

1. **Отложенный запрос разрешений.**

   - Функция `prepareMedia()` вызывается только после действия пользователя (например, кнопка «Подготовить камеру»).
   - Экран `enter` отображается до появления системного диалога разрешений, чтобы пользователь понимал контекст запроса.

2. **Обработка ошибок доступа.**

   - Различать исключения `NotAllowedError`, `NotFoundError`, `NotReadableError` и др.
   - Отображать конкретные подсказки и советы по восстановлению доступа.
   - Использовать `navigator.permissions.query`, чтобы определять постоянный запрет и предлагать пошаговую инструкцию.

3. **Восстановление устройств.**

   - Подписываться на событие `devicechange` и реагировать на возвращение устройств.
   - После восстановления камеры или микрофона отображать уведомление («Камера снова работает»).

4. **Минимальные UX-требования.**
   - На первом экране — короткое объяснение, зачем нужны камера и микрофон.
   - Кнопка `Разрешить доступ` или `Повторить попытку` должна быть заметной.
   - При отсутствии устройств приложение продолжает работу в режиме без медиа, сохраняя соединение по сигналингу.

---

## 6. Связи

- `./structure.md` — структура каталогов и расположение `app.js`.
- `./ui/screens.md` — модель интерфейсных экранов.
- `./ws.md` — формат обмена по WebSocket.
- `./rtc.md` — взаимодействие через WebRTC.
- `./pwa.md` — регистрация сервис-воркера и обновление версии.

---

## Итог

Модуль `app.js` — координатор HomeCall PWA.  
Он управляет состояниями приложения, сигналингом и WebRTC, а также обеспечивает понятное и контролируемое взаимодействие пользователя с разрешениями на медиаустройства.
