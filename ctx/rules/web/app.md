# Браузерное приложение проекта ДомоЗвон

## Назначение

Документ описывает поведение браузерного приложения ДомоЗвон как единой системы.  
Он фиксирует роль `HomeCall_Web_Core_App`, которая управляет жизненным циклом, синхронизацией состояния UI, медиа и сети, не допуская сложных меню, toolbar или множественных экранов.

---

## 1. Роль приложения

- Оркеструет контуры Core, Ui, Media, Net, Rtc, Env и Shared, поддерживая последовательность `home → invite → call → end`.
- Уточняет поведение PWA: автономность, обновления и устойчивость при потере сигнала.
- Ведёт пользователя через один крупный поток, но теперь вставляет экран `invite`, где формируется ссылка перед запуском WebRTC.
- Хранит имя один раз в `localStorage`, но предлагает на `home` быстрые кнопки **«Изменить имя»** и **«Очистить кэш»**, чтобы очистить не только имя, но и весь клиентский кэш.
- Передаёт статусы через `HomeCall_Web_Ui_Toast`, а также дублирует медиа-статусы прямо на `call` с индикаторами, русскими пометками (`Готово`, `Заблокировано` и т.п.) и кнопкой **«Повторить»** при блокировке.

---

## 2. Принципы работы

1. **Цикл `home → invite → call → end`.**  
   ДомоЗвон создаёт UUID и показывает экран `invite` с копируемой ссылкой до того, как запускается WebRTC. На `home` заголовок говорит «Один тап — и звонок готов.», а поясняющий текст («Мы запоминаем имя…») и баннер остаются на русском, чтобы пользователь сразу понял, что нужно сделать.
2. **Минимализм и три зоны.**  
   Каждый экран строится из header/action/hint; `ui-large` гарантирует, что поля и кнопки — **«Сохранить и позвонить»**, **«Позвонить»**, **«Скопировать ссылку»**, **«Поделиться»**, **«Начать звонок»**, **«Завершить звонок»**, **«Вернуться на главную»** — остаются крупными, заметными и удобными для сенсорного ввода.
3. **Имя однажды, но легко сбрасывается.**  
   После первого сохранения `home` показывает баннер «Используется имя: <name>», кнопки **«Изменить имя»** и **«Очистить кэш»**, а toast (например, «Имя очищено. Введите новое имя, чтобы продолжить») напоминает, что форму можно вернуть.  
   Нажатие **«Очистить кэш»** сбрасывает хранилище (`storage.resetMyData()`), вызывает `HomeCall_Web_Pwa_CacheCleaner$`, очищает CacheStorage и локальные сервис-воркеры, показывает toast `Очистка кэша и локального хранилища...` и перезагружает страницу.
4. **Контекстный текст для входящих ссылок.**  
   Если URL содержит `room=<uuid>` и имени нет, home показывает текст «Вас пригласили в комнату <room>. Введите имя, чтобы присоединиться» и не запускает звонок автоматически, пока пользователь не введёт имя.
5. **Экран invite.**  
   Показывает ссылку и заголовок «Ссылка готова. Отправьте её собеседнику.», кнопки **«Скопировать ссылку»** и **«Поделиться»** (если Share API доступен) и **«Начать звонок»», а toast сообщает «Ссылка отправлена» или «Ссылка скопирована в буфер обмена», чтобы подтвердить действие.
6. **Медиа-статусы прямо на call.**  
   Call дублирует статусы из `MediaManager` с русскими метками (`Готово`, `Приостановлено`, `Заблокировано`, `Не поддерживается`, `Ожидание`), показывает кнопки **«Повторить»** при блокировке и **«Завершить звонок»**, а `toast` отражают любые сетевые/медийные ошибки на русском (`Связь потеряна`, `Не удалось установить соединение` и т.п.).

---

## 3. Состояния и переходы

| Состояние | Назначение |
| --------- | ---------- |
| **home**  | Сбор имени или показ сохранённого имени, кнопка **«Позвонить»**, кнопки **«Изменить имя»** / **«Очистить кэш»**, баннер «Используется имя: <name>» и подсказка «Вас пригласили в комнату…» при `room`-параметре. |
| **invite** | Отображает ссылку, **«Скопировать ссылку»**, **«Поделиться»** (если доступно) и **«Начать звонок»**, с заголовком «Ссылка готова. Отправьте её собеседнику.» и русским уведомлением о копировании. |
| **call**  | Активный звонок: поток собеседника, миниатюра локального стрима, кнопка **«Завершить звонок»**, индикаторы камеры/микрофона с русскими статусами и текстовые сообщения в `toast`. |
| **end**   | Сообщение о завершении и кнопка **«Вернуться на главную»**; медиа остановлены, но имя сохраняется и `home` готов к следующему потоку. |

### Переходы

- `home → invite`: при нажатии **«Позвонить»** (или после сохранения имени) генерируется UUID, ссылка отображается в invite, а `home` держит информацию о текущем имени.
- `invite → call`: после нажатия **«Начать звонок»** выполняется `prepareLocalMedia()`, `peer.start()` и отображается `call`.
- `call → end`: завершение вызова (ручной щелчок на **«Завершить звонок»**, ошибка сети или меди) вызывает `endCall`, очищает медиа и показывает `end`.
- `end → home`: пользователь нажимает **«Вернуться на главную»**, URL очищается, `state.activeRoom` сбрасывается, но имя остаётся, поэтому `home` сразу показывает баннер и кнопку **«Позвонить»**.
- `home (по ссылке)` без имени: показывается входящий текст «Вас пригласили в комнату…» и форма имени; после сохранения вызывается `startIncomingCall`.
- Во время `call` ошибки и статусные сообщения по-прежнему появляются в `toast`, а визуальные индикаторы продолжают отображать состояние камеры/микрофона.

---

## 4. Жизненный цикл и взаимодействия

- `HomeCall_Web_Core_App` координирует `HomeCall_Web_Media_Manager`, `HomeCall_Web_Net_SignalClient` и `HomeCall_Web_Rtc_Peer`, поддерживая связь между стадиями.
- `home` вызывает `share-link.md` для генерации, Web Share API и fallback; `toast` сообщает «Ссылка готова» или «Скопировано».
- `call` обновляет медиаэлементы: `#remote-video`, `#local-miniature`, `#no-media`. Любые ошибки (сеть, медиа) отображаются через `notifications.md`.
- `end` получает `connectionMessage` и использует его для пояснений; после возврата в `home` `share-link` очищает одноразовую ссылку, но сохраняется имя.
- Нет событий `ui:action:share-link`, `ui:action:settings` или других toolbar-акций — всё управляется локальными методами `home`.

---

## 5. Связи

- `ctx/rules/web/ui/home.md`, `share-link.md`, `screens.md`, `screens/call.md`, `screens/end.md` — описывают экранные состояния и их взаимодействие.
- `ctx/product/overview.md`, `features.md`, `features/invite.md` — задают продуктовые ограничения: однокнопочный звонок, автоматическое создание комнаты, сохранение имени и минимальный интерфейс.
- `ctx/product/scenarios/first-run.md`, `daily-use.md`, `primary-call.md` — детализируют первые шаги, ежедневные потоки и основной вызов.
- `ctx/rules/web/notifications.md` — `toast`-статусы о ссылке, медиа и сетевых ошибках.

---

## 6. Локализация

- Все пользовательские тексты браузерного слоя (`home`, `invite`, `call`, `end`, `toast` и подсказки) отображаются на русском языке: заголовки, кнопки, статусы и уведомления используют фразы вроде «Один тап — и звонок готов.», «Сохранить и позвонить», «Ссылка готова. Отправьте её собеседнику.» и «Связь потеряна».
- Сообщения логгирования (`log.error`, `console.warn`, `console.error` и другие трассировки) остаются на английском, чтобы разработчики и инструменты анализа получали предсказуемые строки без локализации.
