# Универсальные принципы контейнера @teqfw/di

## Назначение

Документ описывает принципы использования контейнера зависимостей **@teqfw/di** во всех проектах TeqFW и служит опорой для проектных правил `../teqfw.md`.

## Платформа

- `@flancer32/teq-web` — Node.js-обёртка, предоставляющая HTTP-слой и использующая `@teqfw/di` для управления зависимостями.
- Контейнер поддерживает ESM и применяется в приложениях без привязки к конкретному фреймворку.

## Применение DI

- **Late binding** — зависимости разрешаются при запросе, что упрощает замену и тестирование модулей.
- **Inversion of Control (IoC)** — контейнер управляет созданием экземпляров и их жизненным циклом.
- **ESM-совместимость** — модули пишутся в формате ECMAScript Modules без использования `require`.
- **Naming-схема** — идентификаторы повторяют структуру каталогов: `Namespace_Component` ↔ `Namespace/Component.js`.
- **Инициализация контейнера** — класс контейнера экспортируется по умолчанию (`import Container from '@teqfw/di';`).
- **Настройка резолвера** — пространство имён подключается через `container.getResolver().addNamespaceRoot('Prefix_', '/abs/path/src');`, а дополнительные операции выполняются только средствами резолвера, перечисленными в официальной документации `@teqfw/di`.

## Реплейсмент namespace и подмена контрактов

- Контейнер поддерживает **pre-processor**, позволяющий изменять имя запрашиваемого объекта до его загрузки.
- Для этого используется встроенный модуль `Teqfw_Di_Pre_Replace`, доступный в исходниках пакета `@teqfw/di`.
- Подключение осуществляется через добавление namespace-корня и регистрацию чанк-обработчика:

```js
resolver.addNamespaceRoot("Teqfw_Di_", "/abs/path/to/node_modules/@teqfw/di/src");
const pre = container.getPreProcessor();
const replacer = await container.get("Teqfw_Di_Pre_Replace$");
pre.addChunk(replacer);
replacer.add("HomeCall_Back_Contract_Logger", "HomeCall_Back_Logger");
```

- Любой запрос `HomeCall_Back_Contract_Logger$` будет перенаправлен на `HomeCall_Back_Logger$`, что позволяет заменять контракты их реализациями без изменения исходного кода.
- Механизм используется для тестов, моков и отладочных подмен, не применяется в production-окружении.

## Экспорт и внедрение

- Один модуль отвечает за одну роль (`Data`, `Logic`, `Service` и т.д.).
- Допустимые экспорты: объект, фабрика или класс по умолчанию; конструктор принимает `{ deps }`.
- Все зависимости передаются в виде плоского объекта `deps`; вложенные разрешения не допускаются.

## Гарантии контейнера и проверка зависимостей

Контейнер @teqfw/di гарантирует корректность разрешения зависимостей при создании
любой компоненты. Если обязательная зависимость отсутствует, имеет неверный идентификатор
или не может быть создана, контейнер не выполнит инициализацию объекта и зафиксирует
ошибку конфигурации на стадии разрешения.

Из этого следует правило: **модули не выполняют ручных проверок наличия зависимостей
в конструкторах**. Конструкции вида `if (!dep)` считаются избыточными и не применяются.

Объект принимает зависимости декларативно; ответственность за их наличие полностью
лежит на контейнере. Допустимы только проверки условий, которые не относятся к DI,
например:

- наличие `document` или `window` в браузерном окружении;
- доступность конкретных DOM-узлов при инициализации интерфейса;
- проверка особенностей платформы исполнения, не связанных с контейнером.

## Жизненный цикл

- Контейнер создаётся один раз на приложение и выдаёт экземпляры по требованию.
- Singleton-компоненты кэшируются; множественные экземпляры создаются через ключ `$$`.
- Подмена зависимостей моками допускается через явное переопределение резолверов.

## Иммутабельность экземпляров

- Все объекты, возвращаемые контейнером, **замораживаются** (`Object.freeze`).
- Это гарантирует неизменность внедрённых зависимостей и предотвращает их случайную модификацию.
- Попытка изменить свойство такого объекта вызывает `TypeError: Cannot assign to read only property`.
- Для хранения изменяемых данных используйте внутреннее состояние модуля (замыкания, приватные поля, отдельные структуры).

## Связанные документы

- `../teqfw.md` — проектные правила применения этих принципов.
- `../../architecture.md` — архитектурный обзор Связист, указывающий на роль DI.
- `./module-template.md` — шаблон ES6-модуля, используемый при генерации новых компонентов TeqFW.

## Результат

Универсальные правила DI, описанные здесь, обеспечивают единообразие проектов TeqFW и используются как базовая ссылка для всех производных документов.
