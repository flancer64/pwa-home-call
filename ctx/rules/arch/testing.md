# Принципы тестирования системы Связист (ctx/rules/arch/testing.md)

## Назначение

Документ определяет общие принципы тестирования проекта **Связист**.
Он формирует единые стандарты для всех направлений (Node.js и Web), задаёт цели тестирования, уровни изоляции и критерии качества.
Рамочный документ не содержит средоспецифичных инструкций и служит точкой согласования тестовой политики на уровне архитектуры.

> **Согласованность с продуктом:** `ctx/product/overview.md` и `ctx/product/capabilities/connection.md` описывают жизненный цикл `ready → waiting → active`, поэтому тесты должны моделировать переходы между этими состояниями, даже если текущие реализации используют экраны `home`, `invite`, `call`, `end`. Обновление терминологии и единого окна зафиксировано в `ctx/agent/plan/2025/11/20251129-rules-implementation-fixes.md`, но тестовая инфраструктура уже опирается на тех же DI-интерфейсах, что и будущая state machine.

---

## Цели тестирования

- Проверить соответствие реализации контрактам модулей.
- Гарантировать воспроизводимость и предсказуемость работы приложения.
- Обеспечить защиту от регрессий при изменениях кода.
- Поддерживать структурную целостность и стабильность DI-архитектуры.
- Служить дополнительной спецификацией поведения системы.

---

## Область действия

Правила распространяются на **модульные тесты (unit tests)** проекта **Связист**.
Их задача — проверять корректность публичного поведения каждого модуля в изоляции от внешней среды.
Все тесты выполняются внутри DI-контейнера и используют реальные зависимости проекта, за исключением явно подменённых по контракту.

Отдельные правила среды описаны в профильных документах:

- `ctx/rules/node/testing.md` — тестирование Node-компонентов;
- `ctx/rules/web/testing.md` — тестирование Web-компонентов.

---

## Базовые принципы

### 1. Изоляция

Каждый тест выполняется в независимом окружении:

- создаётся новый DI-контейнер;
- тесты не зависят от состояния предыдущих;
- любые глобальные объекты (окружение, конфигурация) восстанавливаются в `finally`.

### 2. Контрактность

Тест проверяет только **публичное поведение** модуля:

- запрещено использовать внутренние свойства или приватные методы;
- интерфейс модуля считается контрактом;
- изменение контракта требует пересогласования тестов и контекста.

### 3. Идемпотентность

Повторный запуск тестов при одинаковом коде должен давать одинаковый результат:

- тесты не модифицируют внешние файлы, сеть или состояние базы данных;
- фикстуры создаются и уничтожаются в рамках одного теста.

### 4. Репрезентативность

Тест отражает реальные условия работы:

- все зависимости создаются контейнером;
- замены (`mocks`) имитируют внешние компоненты только в границах их контрактов;
- тесты не подменяют архитектурное поведение системы.

### 5. Язык и стиль

- Все сообщения и логи в тестах — на английском языке.
- Имена тестов формулируются декларативно, описывая ожидаемое поведение (например, `"stops signaling server on shutdown"`).
- Структура файлов зеркалирует `src/`-каталоги:

```text
src/Area/Module.js → test/unit/Area/Module.test.mjs
```

---

## Организация тестовой среды

- Основной инструмент: `node:test` и `node:assert/strict`.
- Каждый слой (Node и Web) использует свой _helper_ для инициализации DI-контейнера.
- В тестах запрещено обращаться к исходным файлам напрямую — доступ осуществляется только через резолвер контейнера.
- Запуск выполняется через стандартные npm-скрипты:

```bash
npm run test:unit   # Тесты Node-компонентов
npm run test:web    # Тесты Web-компонентов
```

- Все тесты должны завершаться без побочных эффектов и оставлять систему в исходном состоянии.

### Запрет статических импортов

- В тестовых файлах **запрещено выполнять статические импорты модулей проекта**.
- Исключения допускаются только для:

  - встроенных тестовых библиотек (`node:test`, `node:assert/strict`, `sinon` и аналогичных);
  - вспомогательных модулей тестовой инфраструктуры (`helper.mjs`, фикстуры, утилиты).

- Все объекты приложения должны загружаться **только через DI-контейнер**:

  ```js
  const app = await container.get("HomeCall_Web_Core_App$");
  ```

- Это правило обеспечивает соответствие тестов архитектурной модели TeqFW и предотвращает обход контейнера зависимостей.
- Контейнер гарантирует корректность зависимостей, поэтому ручные проверки вида
  `if (!dep)` в конструкторах модулей отсутствуют. Тесты учитывают это правило и
  получают компоненты только через контейнер.

---

## Контроль согласованности

1. Изменение интерфейса модуля без обновления тестов считается нарушением согласованности.
2. Ошибки при `npm run test:...` трактуются как сбой архитектурного контракта.
3. Каждый новый модуль должен сопровождаться зеркальным тестом.
4. Отсутствие теста на новый код требует обоснования в архитектурном контексте.

---

## Роль тестов в архитектуре

Тесты — это не вспомогательный код, а часть архитектурной модели.
Они фиксируют поведение компонентов, демонстрируют границы изоляции и служат механизмом проверки целостности.
Тестовая среда является частью инфраструктуры и подчиняется тем же правилам документирования, что и основной код.

---

## Ссылки

- `ctx/rules/node/testing.md` — правила тестирования Node-компонентов.
- `ctx/rules/web/testing.md` — правила тестирования Web-компонентов.
- `ctx/rules/arch/di.md` — архитектура контейнера зависимостей.
- `ctx/rules/arch/modules.md` — структура и соглашения по модулям.

---

## Итог

Документ закрепляет единый подход к тестированию проекта **Связист**:
все тесты представляют собой спецификации поведения, поддерживают изоляцию, контрактность и идемпотентность.
Он обеспечивает методологическую основу для профильных правил по направлениям Node и Web.
