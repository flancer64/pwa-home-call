# Backend Связист (`ctx/rules/arch/back.md`)

## Назначение

Документ фиксирует архитектуру серверной части **Связист** — совокупность Bootstrap-скрипта (`bin/server.js`) и головного модуля приложения (`HomeCall_Back_App`).  
Оба компонента образуют единый процесс, реализующий запуск и жизненный цикл backend-части системы.

## 1. Структура и роли

- **Bootstrap-скрипт (`bin/server.js`)** — composition root.  
  Загружает конфигурацию из `.env`, создаёт и настраивает контейнер зависимостей `@teqfw/di`, регистрирует namespace проекта и передаёт управление приложению.

- **Головной модуль (`HomeCall_Back_App`)** — точка выполнения бизнес-логики.  
  Принимает внедрённые зависимости (например, логер, конфигурацию, сервер) и управляет жизненным циклом приложения: `run()` → `stop()`.

## 2. Взаимодействие компонентов

1. Bootstrap создаёт контейнер:

   - подключает корень namespace `HomeCall_` к каталогу `src/`;
   - регистрирует внешние пространства (например, `Fl32_Web_` для `@flancer32/teq-web`);
   - подгружает конфигурацию окружения;
   - инициирует DI-контейнер без бизнес-логики.

2. Контейнер возвращает экземпляр:

   ```js
   const app = await container.get("HomeCall_Back_App$");
   await app.run();
   ```

3. Модуль `HomeCall_Back_App` запускает внутренние сервисы и остаётся активным до остановки процесса или сигнала `SIGINT`.
   При завершении вызывается `app.stop()` для корректного освобождения ресурсов.

## 3. Жизненный цикл backend-приложения

| Этап     | Ответственный компонент | Действие                                       |
| -------- | ----------------------- | ---------------------------------------------- |
| **Init** | `bin/server.js`         | создание контейнера, регистрация namespace     |
| **Run**  | `HomeCall_Back_App`     | запуск серверов и внутренних служб             |
| **Stop** | `HomeCall_Back_App`     | логирование завершения и освобождение ресурсов |

## 4. Интеграция с архитектурой TeqFW

Backend полностью совместим с принципами **TeqFW**:

- все зависимости разрешаются через контейнер `@teqfw/di`;
- модули оформлены как ESM с декларативными конструкторами;
- код хранится под `src/Back/` и следует правилам `ctx/rules/arch/teqfw.md`.

## 5. Связи с другими документами

- `../node/bin/server.md` — правила генерации Bootstrap-скрипта;
- `./env/config.md` — конфигурация окружения и передаваемые переменные для backend-приложения.
- `./env/node.md` — окружение Node.js и требования к серверу;
- `./logging.md` — логирование и формат сообщений;
- `./teqfw.md` — структура Back-зоны и namespace-маппинг.

## 6. Сигналинг WebSocket

Backend Связист включает встроенный сервер **WebSocket-сигналинга**, обеспечивающий обмен SDP и ICE-сообщениями между клиентами WebRTC.  
Компонент реализован как часть приложения `HomeCall_Back_App` и запускается в том же процессе Node.js.

- Канал `/signal` обслуживается модулем `HomeCall_Back_Service_Signal_Server`.
- Сообщения маршрутизируются по одноразовым `sessionId`, без использования комнат или персональных имён.
- Сервер не хранит личные данные и никогда не сохраняет историю, а сигналы пересылаются только между участниками текущей сессии.
- Формат и поведение протокола зафиксированы в документе `./back/signal.md`.

## Итог

Backend Связист — однопроцессная система, в которой Bootstrap-скрипт формирует инфраструктуру, а головной модуль управляет логикой и жизненным циклом приложения.
Документ задаёт декларативную основу для согласованной инициализации и запуска серверной части проекта.
