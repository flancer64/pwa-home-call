# Сигналинг WebSocket в ДомоЗвон (`ctx/rules/arch/back/signal.md`)

## Назначение

Документ описывает реализацию серверной части сигналинга **ДомоЗвон**, обеспечивающей обмен SDP и ICE-сообщениями между клиентами PWA при установлении WebRTC-соединения.  
Компонент встроен в backend-приложение и не требует отдельного контракта или внешних зависимостей.

---

## 1. Роль в архитектуре

Сигналинг — часть модуля `HomeCall_Back_App`, который управляет его запуском и остановкой.  
Компонент обслуживает путь `/signal`, принимает WebSocket-соединения и маршрутизирует JSON-сообщения между пользователями комнаты, определённой кодовым словом.
Передача медиаданных не осуществляется.

---

## 2. Основные функции

| Задача                 | Описание                                                                                        |
| ---------------------- | ----------------------------------------------------------------------------------------------- |
| Подключение клиентов   | Принимает соединения и регистрирует пользователей по `room` и `user`, сохраняя метаданные сокета.                           |
| Маршрутизация сигналов | Пересылает `offer`, `answer`, `candidate` адресатам внутри комнаты, буферизуя сигналы до появления собеседника и логируя каждую попытку ретрансляции.                             |
| Завершение сеансов     | Удаляет пользователя при `leave` или обрыве соединения.                                         |
| Обработка ошибок       | Возвращает `{type:"error",message:"Invalid message"}` при некорректных данных.                  |

---

## 3. Форматы сообщений

| Тип         | Направление                  | Поля                      | Назначение                 |
| ----------- | ---------------------------- | ------------------------- | -------------------------- |
| `join`      | клиент → сервер              | `room`, `user`            | вход в комнату             |
| `leave`     | клиент → сервер              | `room`, `user`            | выход из комнаты           |
| `offer`     | клиент → сервер → получатель | `room`, `from`, `sdp`       | SDP-предложение            |
| `answer`    | клиент → сервер → получатель | `room`, `from`, `sdp`       | SDP-ответ                  |
| `candidate` | клиент ↔ сервер ↔ получатель | `room`, `from`, `candidate` | ICE-кандидат               |

Когда собеседник ещё не подключился, соответствующие `offer`/`candidate` сохраняются в простой очередь на стороне сервера и доставляются сразу после регистрации нового сокета; все такие события логируются через `HomeCall_Back_Logger`.
| `error`     | сервер → клиент              | `message`                 | сообщение об ошибке        |

---

## 4. Структура модулей

```text
src/Back/
├── Service/
│   └── Signal/
│       ├── Server.js        # WebSocket-сервер: запуск и маршрутизация
│       └── RoomManager.js   # учёт пользователей и комнат
└── App.js                   # точка инициализации и жизненного цикла приложения
```

- `HomeCall_Back_Service_Signal_Server` — основной модуль сигналинга;
- `HomeCall_Back_Service_Signal_RoomManager` — вспомогательный менеджер подключений.

---

## 5. Интеграция и развёртывание

- `HomeCall_Back_App.run()` создаёт экземпляр `Signal_Server` и вызывает `start()`.
- `App.stop()` завершает работу через `signal.stop()`.
- Apache проксирует `wss://<host>/signal` на `ws://127.0.0.1:$WS_PORT/signal`.
- Порт и параметры передаются через `.env` (`WS_PORT`). Конфигурация параметров, включая порт `WS_PORT`, задаётся в `.env` и документирована в `../env/config.md`.
- Все события логируются через `HomeCall_Back_Logger`.

---

## 6. Безопасность

- Используется только `wss://`.
- Доступ в комнату ограничивается кодовым словом.
- Сервер не сохраняет историю сообщений.
- Все данные передаются в формате JSON (UTF-8).
- Не используется хранение состояния за пределами процесса.

---

## Итог

Сигналинг ДомоЗвон — минимальный встроенный WebSocket-сервер, обрабатывающий обмен SDP/ICE-сообщениями между браузерами.
Он создаётся и управляется модулем `HomeCall_Back_App`, использует `RoomManager` для учёта подключений и логгер для диагностики, оставаясь простым и автономным элементом backend-архитектуры.
