# **WebRTC Media Flow (HomeCall / ДомоЗвон)**

Путь: `ctx/rules/arch/rtc/media-flow.md`

---

## 1. Назначение

Документ устанавливает единый порядок работы медиапотока WebRTC во всех компонентах HomeCall.
Он описывает логику `RTCPeerConnection`, обработку локальных и удалённых треков и применение ICE-кандидатов.
Работа сигналинга описана отдельно в `signaling.md`.

---

## 2. Базовые принципы

1. В рамках одной RTC-сессии создаётся один `RTCPeerConnection`.
2. Оба участника используют одинаковый алгоритм работы с медиа — различия только в ролях offer/answer.
3. Локальные треки добавляются **до** генерации SDP.
4. `ontrack` — единственный источник remote-stream.
5. ICE-кандидаты применяются немедленно, без буферизации.

---

## 3. Алгоритм участника A (инициатор вызова)

1. Получить локальный медиа-стрим.
2. Создать `RTCPeerConnection`.
3. Добавить **все** треки локального стрима.
4. `createOffer → setLocalDescription(offer)`.
5. Отправить offer через сигналинг.
6. Получить и применить answer (`setRemoteDescription`).
7. Принимать входящие ICE (`addIceCandidate`).
8. При первом `ontrack` — сформировать remote-stream и отобразить.

---

## 4. Алгоритм участника B (принимающий вызов)

1. Получить локальный медиа-стрим.
2. Создать `RTCPeerConnection`.
3. Добавить локальные треки.
4. Применить offer (`setRemoteDescription`).
5. `createAnswer → setLocalDescription(answer)`
6. Отправить answer через сигналинг.
7. Принимать ICE (`addIceCandidate`).
8. При первом `ontrack` — отобразить remote-stream.

---

## 5. Правила для локального потока

1. Локальный поток создаётся один раз на участника.
2. Должен быть получен до offer/answer.
3. Изменения треков требуют renegotiation (не используется в MVP).
4. Локальный поток не меняется в рамках одного вызова.

---

## 6. Правила обработки remote-stream

1. Remote-stream формируется **только** в обработчике `pc.ontrack`.
2. Несколько треков могут приходить в одном событии — они добавляются в общий `MediaStream`.
3. Клиент использует единый объект `remoteStream`.
4. Обновление remote-stream выполняется без пересоздания объекта.
5. UI реагирует на первое появление и на добавление новых треков.

---

## 7. Правила ICE

1. ICE-кандидаты отправляются сразу после появления.

2. Входящие кандидаты применяются немедленно:

   ```
   pc.addIceCandidate(candidate)
   ```

3. Клиент не буферизует ICE-кандидаты.

4. ICE-restart не используется в MVP.

5. Диагностика и восстановление соединения выполняются через сигналинг (`signaling.md`).

---

## 8. Жизненный цикл PeerConnection

1. Создание — после получения локального медиа.

2. Активное состояние — после успешного обмена SDP и ICE.

3. Завершение — при `hangup` или закрытии сигналинга.

4. Завершение выполняется вызовом:

   ```
   pc.close()
   ```

5. При неинтенциональном разрыве WebRTC (`connectionState = "disconnected" | "failed"`)
   клиент **не пытается выполнять ICE-restart самостоятельно**.
   Восстановление выполняется через сигналинг:
   пересоздание PeerConnection и повторный обмен SDP/ICE описаны в `signaling.md`.

---

## 9. Ограничения HomeCall

1. Одно RTCPeerConnection на `sessionId`.
2. Нет renegotiation в runtime.
3. Нет переключения треков.
4. Только P2P (2 участника).
5. Одинаковая TURN/STUN конфигурация у обоих участников.

---

## 10. Нормативность документа

`media-flow.md` устанавливает единственно допустимую логику работы медиапотока HomeCall.
Все реализации Peer, CallFlow, UI и Codex-агента обязаны следовать указанной последовательности.
