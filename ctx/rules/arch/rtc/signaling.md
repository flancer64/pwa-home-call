# **Signaling Protocol (HomeCall / ДомоЗвон)**

Путь: `ctx/rules/arch/rtc/signaling.md`

---

## 1. Назначение

Документ определяет единый протокол сигналинга WebRTC для фронтенда и бэкенда HomeCall.
Это нормативное описание, которому обязаны следовать все компоненты.

---

## 2. Модель взаимодействия

HomeCall использует двухточечную RTC-сессию:

```text
sessionId : string
```

В сессии участвуют ровно два клиента.
Маршрутизация выполняется **только** по `sessionId`.
Любые дополнительные идентификаторы не применяются.

---

## 3. Формат сообщений

### offer

```json
{ "type": "offer", "sessionId": "...", "sdp": "..." }
```

### answer

```json
{ "type": "answer", "sessionId": "...", "sdp": "..." }
```

### candidate

```json
{ "type": "candidate", "sessionId": "...", "candidate": { ... } }
```

### hangup

```json
{ "type": "hangup", "sessionId": "...", "initiator": "caller|callee" }
```

### error

```json
{ "type": "error", "sessionId": "...", "message": "..." }
```

Иные поля запрещены.

---

## 4. Поведение сервера

1. Принять WebSocket-соединение по `/signal`.
2. Зарегистрировать сокет в контексте `sessionId` (до двух участников).
3. При получении offer/answer/candidate:
   – определить `sessionId`;
   – переслать сообщение второму участнику;
   – если он не подключён, сохранить сообщение в очереди и доставить позже.
4. При закрытии сокета:
   – удалить сокет из сессии;
   – очистить очередь, если участников не осталось.
5. Сервер не хранит долговременное состояние.
   Все данные живут только в памяти процесса.

---

## 5. Требования к клиенту

1. Клиент использует **один WebSocket** сигналинга в рамках текущей RTC-сессии.
2. Все сообщение обязаны содержать `sessionId`.
3. До соединения с сигналингом клиент должен:
   – получить локальный медиа-стрим;
   – создать `RTCPeerConnection`;
   – добавить локальные треки.
4. Инициатор:
   `createOffer → setLocalDescription → offer`.
5. Принимающий:
   `setRemoteDescription(offer) → createAnswer → setLocalDescription → answer`.
6. ICE:
   – отправлять кандидаты сразу;
   – входящие кандидаты применять немедленно.

---

## 6. Жизненный цикл WebSocket сигналинга

1. WebSocket создаётся **только при начале RTC-сессии**, после:

   ```text
   getUserMedia → peer.prepare → signaling.connect(sessionId)
   ```

2. WebSocket **остаётся открытым весь разговор** (до явного `hangup`).

3. Все сообщения (`offer`, `answer`, `candidate`, `hangup`, `error`) передаются
   **только через активный WebSocket** текущей RTC-сессии.

4. Явное завершение разговора:
   – клиент отправляет `hangup`;
   – закрывает PeerConnection;
   – закрывает WebSocket.

5. Клиент не должен открывать сигналинг заранее или поддерживать его вне активного звонка.

---

## 7. Автоматическое восстановление сигналинга

1. Любой неинтенциональный обрыв WebSocket считается временным.
2. Клиент обязан автоматически переподключиться к `/signal` с тем же `sessionId`.
3. После восстановления клиент повторно отправляет:
   – свою локальную SDP (offer/answer), если она актуальна;
   – все доступные ICE-кандидаты.

---

## 8. Восстановление медиасоединения через сигналинг

Если после восстановления WebSocket текущее WebRTC-соединение находится в состоянии:

```text
disconnected | failed | closed
```

и не восстанавливается автоматически, клиент обязан:

1. закрыть текущий `RTCPeerConnection`;
2. создать новый `RTCPeerConnection`;
3. заново добавить локальные треки;
4. выполнить повторный обмен SDP/ICE:

   - инициатор создаёт новый offer;
   - принимающий ожидает offer и отвечает answer.

Это единственный допустимый механизм восстановления медиапотока.
Клиент **не выполняет ICE-restart и renegotiation напрямую через WebRTC API** вне контекста сигналинга.

---

## 9. Очереди сигналов

Если один участник отправляет SDP/ICE до подключения второго, сервер сохраняет сообщение в очереди и доставляет при его подключении.

---

## 10. Безопасность

- используется только `wss://`;
- сервер валидирует корректность типов сообщений;
- сервер не раскрывает информацию об участниках;
- состояние не сохраняется вне процесса.

---

## 11. Нормативность

Документ является единственным корректным источником требований к сигналингу HomeCall.
Фронтенд, бэкенд и Codex-агент обязаны реализовывать протокол строго в указанной форме.
