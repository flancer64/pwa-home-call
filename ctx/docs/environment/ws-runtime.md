# Runtime протокол WebSocket

Path: `./ctx/docs/environment/ws-runtime.md`

## Назначение

Документ описывает поведение `/signal` как эксплуатационного канала WebSocket: какие модули инициируют соединение, как повторные подключения обрабатываются, какие проверки выполняются и какие сигналы возвращаются при ошибках.

## Поведение клиента

1. `HomeCall_Web_Core_App` и `HomeCall_Web_Net_Session_Manager$` обеспечивают наличия `sessionId` независимо от UI: он либо создаётся через Flow/`ShareLink` (например, с CTA «Связать»), либо извлекается из внешней ссылки `/?session=<uuid>` до первого рендера экрана. `Env` передаёт `sessionId` в DI-контейнер, и клиент сразу подключается к `/signal`.
2. `Net.startSignal(sessionId)` открывает WebSocket: первый подключившийся клиент остаётся в `waiting`, удерживая overlay шаринга и отправляя `offer` после того, как второй серверный сокет зарегистрируется. Клиент продолжает готовить `Media`, а WebRTC-потоки запускаются сразу после обмена предложением/ответом и ICE-кандидатами.
3. Второй участник, открывший тот же `sessionId`, подключается к `signal`, получает накопленные `offer`/`candidate`, отправляет `answer` и начинает обмен собственными `candidate`; роли `initiator`/`recipient` не назначаются явно, они выводятся только из очередности соединений.
4. Повторное подключение использует тот же `sessionId`; `lastDescription` и `localCandidates` переотправляются, а сервер доставляет накопленные сообщения тому участнику, который вновь вошёл.
5. При разрыве `Core` вызывает `Net.stopSignal()`, а сервер очищает очередь и `sessionId` после того, как обоих клиентов уведомил `hangup`; интерфейс возвращается в `ended`.

## Серверные гарантии

- Сервер сопоставляет `sessionId` с максимум двумя сокетами, не различает роли и продолжает FIFO-очередь до подключения второго участника. После `hangup` или закрытия всех сокетов очередь очищается, а `sessionId` снова становится недействительным.  
- `sessionId` фиксирован на время сеанса; повторное использование описано в `ctx/docs/constraints/node.md`, но инициатива переходит к тому, кто первым заходит по ссылке.  
- Все сообщения логируются по `sessionId` без привязки к персонам и доступны для отладки через агрегаторы, соблюдая требования `ctx/docs/constraints/conventions.md`.

## Безопасность и ошибки

- Подключения проходят только по `wss://`; незашифрованные соединения или переподключения к `ws://` отвергаются.  
- Сервер проверяет `sessionId` на соответствие активному контексту и игнорирует устаревшие значения с ответом `"error"` (например, `"Сессия завершена"`, `"Сигнал не найден"`).  
- При возникновении ошибок клиент получает понятный текст, который отображается через `HomeCall_Web_Ui_Toast$` без раскрытия внутренних данных.

---

Этот документ перенесён из `ctx/docs/architecture/web/infra/ws.md` в рамках нормализации уровней ADSM.
