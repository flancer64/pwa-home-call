# Runtime протокол WebSocket

Path: `./ctx/docs/environment/ws-runtime.md`

## Назначение

Документ описывает поведение `/signal` как эксплуатационного канала WebSocket: какие модули инициируют соединение, как повторные подключения обрабатываются, какие проверки выполняются и какие сигналы возвращаются при ошибках.

## Поведение клиента

1. `HomeCall_Web_Core_App` генерирует `sessionId` при нажатии **«Связать»**, `ShareLink` добавляет его в `/?session=<uuid>` и передаёт через `Env` в DI-контейнер.  
2. После **Связать** `Net.startSignal(sessionId)` устанавливает соединение, `Rtc.startOutgoingSession(sessionId)` пробрасывает `onIceCandidate`, а Media готовится, но WebRTC-потоки запускаются только при получении `answer`.  
3. Получатель ссылки открывает `?session=<uuid>`, `Env` передаёт `session` в `Net`, `Media.prepare()` готовит устройства, `Net.startSignal(sessionId)` начинает слушать `offer`, а `Rtc.startIncomingSession(sessionId)` (или аналог) отправляет `answer`.  
4. Повторное подключение используют тот же `sessionId`; если второй участник ещё не пришёл, `offer`/`candidate` сохраняются в памяти, а сервер доставляет их, как только клиент готов.  
5. При разрыве `Core` вызывает `Net.stopSignal()`, сервер очищает очереди по `sessionId` (`ctx/docs/constraints/node.md`), а `call` переводится в `end` state.

## Серверные гарантии

- Сервер сопоставляет `sessionId` только с активными сокетами и не хранит имена, комнаты или дополнительные сущности.  
- `sessionId` фиксирован на время звонка; после завершения его значение перестаёт восприниматься как действительное, а очистка очередей и повторное использование описаны в `ctx/docs/constraints/node.md`.  
- Все сообщения логируются по `sessionId` без привязки к персонам и доступны для отладки через агрегаторы, соблюдая требования `ctx/docs/constraints/conventions.md`.

## Безопасность и ошибки

- Подключения проходят только по `wss://`; незашифрованные соединения или переподключения к `ws://` отвергаются.  
- Сервер проверяет `sessionId` на соответствие активному контексту и игнорирует устаревшие значения с ответом `"error"` (например, `"Сессия завершена"`, `"Сигнал не найден"`).  
- При возникновении ошибок клиент получает понятный текст, который отображается через `HomeCall_Web_Ui_Toast$` без раскрытия внутренних данных.

---

Этот документ перенесён из `ctx/docs/architecture/web/infra/ws.md` в рамках нормализации уровней ADSM.
