# Развёртывание приложения "Связист"

## Введение

Связист — композитное WebRTC-приложение, включающее несколько взаимосвязанных компонентов:

- **браузерный клиент** — пользовательский интерфейс;
- **сигнальный сервер на Node.js** — координация установления соединений;
- **узлы WebRTC-доступности (STUN/TURN)** — сетевые узлы для прохождения трафика и обхода NAT.

Фронт и сигнальный сервер являются локальными элементами установки; инфраструктура STUN/TURN может быть развёрнута локально либо заменена внешними сервисами.

---

## Обзор

### Компоненты системы

1. **Клиентская часть**
   Статические файлы под управлением веб-сервера; доступ по HTTPS.

2. **Сигнальный сервер**
   Node.js-сервис, принимающий WebSocket-соединения на фиксированном порту.

3. **WebRTC-доступность (STUN/TURN)**
   Два варианта:

   - локальный сервер coturn на Debian,
   - внешний публичный STUN-узел.

### Требования к рабочей среде

- **Адресация:** доменное имя или статические IP для фронта и сигналинга.
- **Шифрование:** валидный HTTPS-сертификат для клиентской части.
- **Порты:** открытый порт сигналинга; для локального coturn — порты STUN/TURN.
- **Конфигурационные связи:** клиент указывает адрес сигналинга; сигналинг — адреса выбранных STUN/TURN-узлов.

---

## Развёрнутое описание

### Подготовка окружения

#### Общие предусловия

- Сервер под Linux с доступом по SSH.
- Установленный веб-сервер с поддержкой HTTPS.
- Домен, привязанный к IP сервера.
- Node.js версии **20+**.
- Свободный локальный порт для WebSocket-сигналинга.
- Каталог для размещения приложения.
- Возможность загрузки релиза с GitHub.
- Доступный STUN-сервер (TURN не используется).

#### Предусловия для текущего документа

- Веб-сервер: **Apache**.
- Домен: **call.example.com**.
- HTTPS на порту **443**.
- WebSocket-порт: **4444**.
- Каталог установки: **/home/user/app/svyazist**.
- Используемая версия: **релиз 0.1.0**.
- STUN-узел: **stun.l.google.com:19302**.

---

### Получение и размещение кода приложения

Код загружается из релиза **0.1.0** и размещается в каталоге установки:

```bash
git clone --branch 0.1.0 https://github.com/flancer64/pwa-home-call /home/user/app/svyazist
```

Создаётся файл окружения:

```bash
cp /home/user/app/svyazist/.env.example /home/user/app/svyazist/.env
```

Указывается порт WebSocket-сигналинга:

```text
WS_PORT=4444
```

Устанавливаются зависимости backend:

```bash
cd /home/user/app/svyazist
npm ci
```

Проверяется запуск backend:

```bash
npm start
```

Ожидаемый вывод:

```text
[INFO] Svyazist backend starting.
[INFO] [Signal] WebSocket signaling server started.
[INFO] Svyazist backend started.
```

Проверка доступности порта:

```bash
ss -tlnp | grep 4444
```

В выводе должен быть слушающий порт `0.0.0.0:4444`.

---

### Настройка Apache и HTTPS

В конфигурации Apache задаётся корневой каталог фронтенда:

```apache
DocumentRoot /home/user/app/svyazist/web
ServerName call.example.com
```

Для получения TLS-сертификата используется Certbot:

```bash
sudo certbot --apache -d call.example.com
```

После успешной настройки:

- `https://call.example.com/` должен отдавать `index.html`,
- браузер должен показывать валидный сертификат,
- команда `apachectl -S` должна отображать VirtualHost для `call.example.com:443`.

---

### Настройка WebSocket-проксирования в Apache

Сигнальный сервер работает локально на порту `4444`, а публичный адрес соединений имеет вид:

```text
wss://call.example.com/signal
```

Для проксирования добавляется маршрут:

```apache
ProxyPass        "/signal"  "ws://127.0.0.1:4444/signal"
ProxyPassReverse "/signal"  "ws://127.0.0.1:4444/signal"
```

Необходимые модули включаются командой:

```bash
sudo a2enmod proxy proxy_http proxy_wstunnel
sudo systemctl restart apache2
```

Проверка:

```bash
apachectl -M | grep proxy
```

WebSocket-соединение должно переходить в состояние **101 Switching Protocols**.

---

### Проверка работы WebRTC

Конфигурация ICE-серверов находится во фронтенд-модуле:

```text
web/app/Rtc/Peer.mjs
```

Базовый набор:

```js
iceServers: [{ urls: "stun:stun.l.google.com:19302" }];
```

(Параметры TURN в текущей установке не используются.)

Для проверки работоспособности:

- открыть `https://call.example.com/` на двух устройствах,
- убедиться, что WebSocket-сигналинг устанавливается,
- проверить наличие обмена SDP и ICE-кандидатами в DevTools,
- выполнить тестовый вызов и дождаться установления медиасоединения.

Если ICE-кандидаты не появляются или соединение не формируется, вероятна блокировка P2P-трафика на стороне клиентов. В этом случае требуется установка собственного STUN/TURN-сервера (например, `coturn`) для обеспечения связности.

---
