# Экран Call

Путь: `ctx/docs/composition/client/ui/screens/call.md`

## Назначение

Экран Call формирует единый контур взаимодействия для этапов ожидания соединения и активного вызова. Все состояния соединения отображаются внутри одной сцены (`call-stage`), без переключения экранов. Внутри неё сохраняются видеоблоки, элементы ожидания, интерфейс шаринга и управляющие действия.

Стили видеослотов находятся в `web/ui/screen/call.css`, где `#main-video` определяется как абсолютный `inset: 0` слой с `object-fit: cover` и фоновой заливкой `#000`, а `call-local` с `overlay-video` используют безопасное позиционирование и `object-fit: cover`, чтобы вся геометрия видеопотоков оставалась в одном файле без дублирования.

Сцена опирается на два видеослота с нейтральными названиями: `main-video` отмечает основной фон и растягивается на всю сцену, а `overlay-video` — малый оверлей `call-local`, куда переселяется превью собственного потока после установления соединения, когда основной слот передаёт соседний видеофид. До подключения второго участника `main-video` показывает локальный поток, но он всегда `muted`, чтобы убрать эхо, а `overlay-video` скрыт и, даже после появления, остаётся без звука.

## Зоны

1. **Stage** — основная сцена вызова, объединяющая:

   - основной видеослот сцены (`main-video`);
   - контейнер `call-local` с малым оверлеем (`overlay-video`) для собственного потока;
   - слой ожидания (`call-waiting`) с текстовой меткой и кнопкой шаринга (`fab-share`).

2. **Controls** — панель управляющих действий (`call-controls`) с двумя FAB-кнопками:

   - `call-settings` — открытие слоя настроек;
   - `end-call` — завершение вызова.

Обе зоны остаются постоянными: изменяются только их видимость и размещение элементов в зависимости от состояния соединения.

## Поведение

### 1. Ожидание соединения

- Пока удалённый поток отсутствует, сцена оформляется как режим ожидания:
  - основной экран (`main-video`) показывает локальный видеофид, но звук `muted` до подключения удалённого участника, а `overlay-video` остаётся скрытым и без кадра;
  - контейнер `call-local` служит обрамлением, готовым принять превью после установления соединения;
  - слой ожидания отображает статус ожидания и предоставляет кнопку шаринга для передачи ссылки;
  - экран остаётся в этом состоянии до получения удалённого видеопотока.

Такой режим объединяет ожидание приглашения, обмен ссылкой и проверку доступности медиа в одной визуальной композиции.

### 2. Активное соединение

- После появления удалённого видеопотока:
  - основной экран (`main-video`) переключается на удалённый видеофид и включает звук, отражая только audio, поступающий с remote stream;
  - локальное видео появляется в малом оверлее (`overlay-video`) внутри контейнера `call-local`, но остаётся muted;
  - слой ожидания скрывается;
  - кнопка шаринга исчезает, так как необходимость обмена ссылкой отпадает.

Переход выполняется без изменения структуры DOM: меняются только классы сцены и видимость слоёв.

### 3. Управляющие действия

- `call-settings` открывает слой настроек поверх текущей сцены;
- `end-call` завершает вызов и возвращает приложение к корневому состоянию.

Функции этих кнопок не зависят от состояния соединения и остаются доступными на протяжении всего сценария вызова.

## Примечания

- `call-stage` использует переключение CSS-классов (`call-stage--waiting`) для управления состояниями без замены компоновки, что уменьшает визуальные артефакты при переходах.
- Ожидание и активный вызов разделяются только логикой отображения потоков и видимости слоёв, что упрощает согласованность поведения.
- Интерфейс шаринга остаётся частью сцены вызова, чтобы пользователю не приходилось переходить на отдельный экран.
- Системный инвариант: локальный поток всегда оставлен muted (в `main` до связи и всегда в overlay), а аудиовывод `main` разрешён только при наличии remote stream.
