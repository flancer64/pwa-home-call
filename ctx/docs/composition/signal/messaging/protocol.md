# Протокол сигналинга для сеанса

Путь: `ctx/docs/composition/signal/messaging/protocol.md`

## Назначение

Документ описывает последовательность фактических сообщений `wss://<host>/signal`, которые обмениваются участники во время единого `sessionId`.

## Последовательность событий

1. **Объявление `sessionId`.** Любой клиент или третья сторона фиксирует ссылку `https://<host>/?session=<uuid>`; она может быть передана напрямую участникам, и сама по себе не создаёт ожидаемое распределение ролей или состояний командования.
2. **Первый WebSocket-клиент подключается.** Сервер регистрирует `sessionId`, открывает FIFO-очередь сообщений и оставляет клиента в `waiting`, пока второе соединение не присоединится; UI отображает контент `waiting`, информируя о готовности к приёму партнёра.
3. **Второй WebSocket-клиент подключается.** Как только второй сокет входит в тот же `sessionId`, очередь доставляется обоим, а клиент, подключившийся первым, отправляет `offer`, а второй — `answer`: динамическое назначение ролей полностью зависит от порядка подключения, а не от URL, кнопок или предварительного статуса.
4. **Обмен ICE-кандидатами.** `candidate`-сообщения продолжают пересылаться между двумя участниками в рамках одной очереди `sessionId`, пока канал устанавливается.
5. **Активный контекст.** Сеанс считается активным после подключения второго WebSocket-клиента, и оба участника используют одно и то же макет `call`, не делая различий между „звонящим“ и „принимающим“.
6. **Завершение.** Любой из двух участников отправляет `hangup`, сервер очищает очередь и `sessionId`, а UI переходит в состояние `ended`.
7. **Ошибки.** `error`-сообщения пересылаются по тому же каналу, чтобы UI мог отразить состояние сбоя и предложить повторить попытку.

## Примечания

- Все сообщения содержат `sessionId`, что делает маршрутизацию тривиальной, а UI остаётся на единой сцене `call`.
- Ключевым элементом модели является порядок подключения: сервер не вводит дополнительную терминологию `initiator/recipient`, а клиент переключает поведение только в зависимости от того, подключён ли уже партнер.
