# **Инварианты узла**

**Path:** `ctx/docs/constraints/node.md`

## Краткое резюме инвариантов

Узел поддерживает множество идентификаторов сеанса параллельно, но каждое пространство существует отдельно и ограничено своим контекстом сеанса.
Контекст сеанса возникает только при обращении по ссылке и действует строго в пределах объявленного идентификатора сеанса, не смешиваясь с другими.
Все сигнальные события и технические состояния принадлежат одному идентификатору сеанса и обслуживают только двух участников.
После завершения сеанса соответствующий контекст исчезает, а идентификатор может быть использован повторно.

Эти инварианты обеспечивают изоляцию состояний, недопущение скрытых сущностей и неизменность двухучастниковой модели независимо от архитектурных решений.

---

## Термины уровня

**Контекст сеанса** — область состояния, создаваемая первым участником при обращении по ссылке и существующая только в рамках одного идентификатора сеанса (`ctx/docs/product/terms.md`).
**Сеанс** — взаимодействие двух участников внутри этого контекста (`ctx/docs/product/terms.md`).
**Узел** — совокупность клиентской и серверной части, поддерживающая множественные параллельные контексты без их пересечения.

---

## Параллелизм и изоляция

- Узел допускает множество параллельных идентификаторов сеанса, но каждый идентификатор создаёт собственный контекст, полностью изолированный от остальных (`ctx/docs/product/overview.md`, `ctx/docs/product/terms.md`).
- Контексты не пересекаются и не делят состояния: сигналы, статусы и технические метки принадлежат только своему идентификатору сеанса и не могут распространяться на другие (`ctx/docs/product/overview.md`, `ctx/docs/product/terms.md`).
- Ограничение «двое участников на идентификатор» действует для каждого параллельного контекста независимо (`ctx/docs/product/capabilities/session.md`).
- После завершения сеанса контекст исчезает, а идентификатор сеанса может быть повторно объявлен без переноса состояний (`ctx/docs/product/terms.md`).

---

## Ограничения сигнала

- Все сообщения сигнального уровня обрабатываются строго в пределах объявленного идентификатора сеанса и не подтверждают, не продолжают и не восстанавливают завершённые или несогласованные контексты (`ctx/docs/product/overview.md`, `ctx/docs/product/terms.md`).
- Сигнальный обмен относится только к двум участникам данного идентификатора сеанса; любые дополнительные стороны выходят за пределы модели продукта (`ctx/docs/product/capabilities/session.md`).
- Сигнальные каналы не порождают сущностей, ролей или комнат: узел транслирует только состояние контекста, созданного обращением по ссылке.

## Сигнальные очереди и повторные подключения

- Сервер хранит ровно два активных WebSocket-соединения на один идентификатор сеанса, сопоставляя каждый сигнал с конкретным контекстом и не допуская пересечения потоков между разными идентификаторами сеанса.
- Если второй участник ещё не подключён, server продуцирует FIFO-очередь сообщений для текущего идентификатора сеанса и доставляет её гостю после подключения, сохраняя порядок для SDP/ICE/command-сигналов (`ctx/docs/architecture/messaging.md`).
- После завершения сеанса и перехода в состояние `ended` очередь очищается, а идентификатор сеанса считается недействительным до полной очистки контекста; повторное использование идентификатора возможно только после выполнения этой очистки.
- Повторные подключения используют тот же идентификатор сеанса, но сервер требует подтверждённый handshake и игнорирует устаревшие сигналы, возвращая `error` с понятным текстом (`"Сеанс завершён"`, `"Сигнал не найден"`) для отображения клиентскому toast-слою (`ctx/docs/architecture/web/infra/ws.md`, `ctx/docs/environment/ws-runtime.md`).
- Ошибки и повторные попытки фиксируются через логгеры `HomeCall_Web_Shared_Logger$`, при этом любой идентификатор сеанса проверяется на активность до обработки тела сообщения, что обеспечивает детерминированность и предсказуемость (`ctx/docs/constraints/conventions.md`).

---

## Итоговая декларация

Узел поддерживает множество независимых контекстов, каждый из которых связан одним идентификатором сеанса, ограничен двумя участниками и существует только в период активного сеанса.
Никакие архитектурные решения не могут расширить эту модель: контексты изолированы, состояния не смешиваются, завершённые пространства не восстанавливаются.

---
