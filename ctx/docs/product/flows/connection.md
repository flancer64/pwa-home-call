# Поток высокоуровневой связи

Path: `./ctx/docs/product/flows/connection.md`

## Идея

Поток фиксирует логическую последовательность состояний, опираясь на инварианты `overview.md` и `capabilities/` без описания механик: он показывает, как объявленные свойства переходят от создания ссылки к завершению сеанса.

## Этапы

- **Объявление ссылки.** Любой участник или третья сторона фиксирует `sessionId` (ссылку) как декларацию доступа к будущему сеансу; ссылка сама по себе не назначает роли, и её можно открыть независимо от интерфейса «Связать».
- **Ожидание партнёра.** Первый подключившийся клиент остаётся в состоянии `waiting`, демонстрируя, что пространство логически открыто и ждёт второго участника; интерфейс остаётся нейтральным, не обозначая «принимающего» или «звонящего», а локальное превью в `main-video` выводится `muted`, чтобы исключить эхо до появления remote stream.
- **Обмен offer/answer.** Как только второй WebSocket-клиент подключается, порядок подключения определяет, кто отправит `offer`, и кто — `answer`; роли появляются динамически и зависят лишь от очередности, а не от URL, кнопки или статуса UI.
- **Активный контекст.** Сеанс считается активным после установления обоих WebSocket-клиентов и подтверждения ICE-кандидатов, при этом оба участника делят один и тот же контекст без дополнительных канонов; аудиовывод разрешён только на удалённый поток, локальное звучание остаётся заблокировано.
- **Завершение сеанса.** Любой из двух участников отправляет `hangup`, сервер очищает очередь и `sessionId`, а узел возвращается в нейтральную готовность нового цикла.

## Постусловия

- Контекст взаимодействия и ссылка больше не активны.
- Участники выходят без постоянных привязок, сохраняя нейтральность относительно создателя ссылки.
