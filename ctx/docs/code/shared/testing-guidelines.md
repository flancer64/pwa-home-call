# Тестовые соглашения уровня code

Path: `./ctx/docs/code/shared/testing-guidelines.md`

Тесты — не вспомогательные скрипты, а часть кода. Они отражают контракт модуля и проверяют, что зависимости разрешаются и используются через DI. Тестовая инфраструктура повторяет кодовую структуру и придерживается тех же требований к стилю и логированию.

## Общие правила

- Каждый тест выполняется в своём DI-контейнере. Helper-ы (`test/unit/helper.mjs`, `test/web/helper.mjs`) создают новый контейнер и регистрируют mock-объекты через `container.register()` или `resolver.addChunk()`.
- Нельзя статически импортировать код из `src/` или `web/app/` — все модули загружаются через `container.get('HomeCall_*$')`, чтобы тесты не обходили контракт DI.
- Тесты используют `node:test`, `node:assert/strict` и библиотеки вроде `sinon`. Логи и названия тестов — на английском.
- Изоляция, идемпотентность и контрактность остаются главными критериями: каждый тест завершается без изменений файловой системы, сетевых соединений или глобальных объектов.
- Запуск тестов через npm-скрипты: `npm run test:unit` для Node и `npm run test:web` для браузерного слоя.

## Node.js-тесты

- Каталог `test/unit/` зеркален `src/Back/`: `src/Back/Service/Signal/Server.js` → `test/unit/Back/Service/Signal/Server.test.mjs`.
- Helper создаёт контейнер, регистрирует logger и mock-сервисы (`HomeCall_Back_Service_Signal_Server$`). Тест получает модули только через DI и проверяет публичные методы (`run`, `start`, `stop`).
- Тесты не открывают реальные сокеты или файловые дескрипторы — асинхронная логика проверяется через стобы и очередь событий.

## Web-тесты

- Каталог `test/web/` повторяет `web/app/`. Контейнер создаётся из `test/web/helper.mjs`; namespace `HomeCall_Web_` используется точно как в production.
- Все модули (`HomeCall_Web_Ui_Flow$`, `HomeCall_Web_Net_Signal_Client$`, `HomeCall_Web_Media_Manager$`) получают зависимости через container; `window`, `navigator`, `WebSocket`, `RTCPeerConnection` эмулируются mock-объектами.
- Статические импорты из `web/app` запрещены. Единственный путь к функционалу — DI-контейнер. Исключения — тестовые утилиты и `node:`-модули.
- Каждый тест очищает глобальные объекты (`window`, `document`, `caches`) и использует `finally`, чтобы вернуть окружение к исходному состоянию.

## Документированность и отчёты

Изменение интерфейса модуля или появление нового контракта требует обновления теста и, при необходимости, документации `ctx/docs/code`. Ошибки сборки тестов фиксируются как нарушение контракта DI и обсуждаются в контексте ADSM.
