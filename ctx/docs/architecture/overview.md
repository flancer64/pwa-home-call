# Архитектурный обзор автономного узла связи

Path: `./ctx/docs/architecture/overview.md`

## Назначение

Документ фиксирует **архитектурную форму** автономного узла связи.
На этом уровне определяются только:

- устойчивые **контуры** системы;
- их **границы ответственности**;
- **архитектурные данные** (идентификатор сеанса, ссылка, события);
- **инварианты**, которые обязаны соблюдаться на всех нижележащих уровнях;
- **архитектурные фазы** жизни контекста.

Документ не описывает реализацию, API, форматы структур, callback-механику, WebRTC/WS-детали, DI-контракты или инфраструктурные механизмы.
Он задаёт **форму**, в рамках которой возможны различные реализации.

---

## Архитектурная форма системы

Автономный узел связи состоит из четырёх устойчивых контуров, взаимодействующих внутри одного архитектурного пространства:

1. **Клиентский контур** — локальная зона участника;
2. **Сигнальный контур** — форма согласования и маршрутизации событий;
3. **Серверный контур** — хранитель контекста и узел идентичности;
4. **Контур прямого взаимодействия** — форма непосредственного обмена между участниками.

Каждый контур опирается на product-инварианты:

- один идентификатор сеанса на одно взаимодействие,
- два участника,
- симметрия ролей,
- отсутствие скрытых состояний, противоречащих constraints-уровню.

---

## Контуры и ответственность

### Клиентский контур

Формирует локальный контекст участника:

- принимает ссылку, извлекает идентификатор сеанса,
- объявляет свои архитектурные события,
- отражает архитектурное состояние (`ready`, `waiting`, `active`, `ended`),
- взаимодействует с сигнальным контуром и контурами среды.

Не содержит протокольных или процедурных механизмов WebRTC/WS; не описывает UI.

---

### Сигнальный контур

Ось согласования между участниками:

- маршрутизирует архитектурные события строго по одному `sessionId`,
- обеспечивает симметрию взаимодействия,
- соединяет клиентские контуры и серверный контур,
- гарантирует, что все события одного контекста образуют единый последовательный поток.

Сигнальный контур не раскрывает структуры событий (JSON, SDP, ICE и др.); он оперирует только формой события как архитектурной единицей.

---

### Серверный контур

Удерживает жизненный контекст:

- подтверждает существование `sessionId`,
- хранит минимальную архитектурную информацию, необходимую для соблюдения инвариантов,
- очищает контекст после завершения,
- обеспечивает изоляцию разных сеансов.

Серверный контур не вводит скрытых состояний, не хранит очередей и не описывает инфраструктуру.

---

### Контур прямого взаимодействия

Форма непосредственного обмена двух клиентских контуров **после** согласования.
Существует строго внутри границ одного `sessionId` и не вносит новых ролей или данных.
Порождается архитектурно, но не описывает технику обмена.

---

## Архитектурные данные

Архитектурный уровень использует три базовых сущности:

### 1. Идентификатор сеанса (`sessionId`)

Единственный якорь контекста.
Определяет область действия всех событий, всех состояний и всех взаимодействий.
Не раскрывает формат, способ генерации или хранения.

### 2. Ссылка

Декларация входа в контекст.
Фиксирует привязку участника к существующему или новому `sessionId`.
Не содержит транспортной логики.
Ссылка может существовать вне активного сеанса.

### 3. Архитектурные события

Минимальные смысловые единицы согласования, связанные с одним `sessionId`.
Событие определяет факт перехода или намерение контуров продолжить согласование.
Не раскрывает внутреннюю структуру и не описывает протокольных деталей.

---

## Архитектурные фазы контекста

Форма существования контекста задаётся четырьмя фазами:

1. **Объявление**
   — ссылка активирует `sessionId`, клиентский контур формирует локальный контекст.
   Никакие события ещё не обменялись.

2. **Согласование участников**
   — сигнальный контур сопоставляет события двух участников,
   — серверный контур удерживает контекст,
   — устанавливается симметрия.

3. **Прямое взаимодействие**
   — после согласования два клиентских контура вступают в непосредственный обмен,
   — все события продолжают принадлежать одному `sessionId`.

4. **Завершение**
   — обмен прекращается,
   — серверный контур удаляет контекст,
   — дальнейшие события невозможны до объявления нового идентификатора.

---

## Инварианты архитектурной формы

Архитектурный уровень удерживает следующие обязательные свойства:

1. **Единый идентификатор**
   — все события и состояния одного взаимодействия принадлежат одному `sessionId`.

2. **Два участника**
   — форма взаимодействия всегда симметрична; роли не вводятся.

3. **Последовательность событий**
   — сигнальный контур удерживает упорядоченность и согласованность.

4. **Строгие границы контуров**
   — ни один контур не раскрывает протокольные или технологические детали уровней ниже design/code.

5. **Отсутствие скрытых состояний**
   — серверный контур не хранит ничего сверх минимального набора для соблюдения инвариантов.

6. **Независимость от реализации**
   — архитектура не фиксирует WebSocket, HTTP, ICE, SDP, DI, UI, инфраструктуру.

---

## Структурная карта уровня

Архитектурная форма раскрывается через дополнительные документы:

- `shapes/client/AGENTS.md` — индекс клиентского пространства с презентацией, состояниями и смысловым циклом;
- `shapes/server/AGENTS.md` — индекс серверного узла с описанием контуров и инвариантов;
- `shapes/signal/AGENTS.md` — индекс сигнального обмена с декларацией событий и маршрутизации;
- `shapes/lifecycle/AGENTS.md` — индекс фазовой структуры с допустимыми переходами;
- `boundaries/*` — границы между контурами.

Все документы являются расширением данного обзора и не могут вводить новые сущности, события, состояния или роли.
