# Фазовая структура контекста

Path: `./ctx/docs/architecture/shapes/lifecycle/AGENTS.md`

## Назначение

Фиксировать архитектурные фазы существования контекста, переходы между ними и связанные инварианты без описания реализации или процедур.

## Фазы

- **Объявление** — ссылка активирует `sessionId`, клиент сигнализирует о наличии контекста, события ещё не обменялись.
- **Согласование участников** — сигнальный контур сопоставляет события второго участника, сервер удерживает контекст и подтверждает симметрию.
- **Прямое взаимодействие** — после согласования клиентские контуры вступают в прямой обмен внутри одного `sessionId`, а сигнальный контур даёт опору согласованности.
- **Завершение** — обмен прекращается, сервер очищает контекст, новые события появляются только после объявления нового `sessionId`.

## Допустимые переходы

- `Объявление → Согласование участников`, когда второе предложение и ответ объединены одним `sessionId`.
- `Согласование участников → Прямое взаимодействие`, когда симметрия подтверждена без конфликтов инвариантов.
- `Прямое взаимодействие → Завершение`, когда участники фиксируют прекращение и `sessionId` очищается.
- `Завершение → Объявление`, только после удаления контекста и появления новой ссылки.

Никакие другие переходы не поддерживаются; фазы образуют линейную цепочку с единственным циклом нового объявления.

## Инварианты

- Все события, относящиеся к фазам, прикреплены к одному `sessionId`.
- Переходы сохраняют симметрию двух участников и не допускают скрытых состояний вне перечисленных фаз.
- Серверный контур очищает контекст сразу после завершения, исключая повторное использование прежнего `sessionId`.

## Карта уровня

- `AGENTS.md` — индекс фазового пространства с описанием фаз, переходов и инвариантов.
