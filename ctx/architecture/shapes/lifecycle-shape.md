# Фазовая структура контекста

Path: `./ctx/architecture/shapes/lifecycle-shape.md`

## Назначение

Фиксирует архитектурные фазы существования контекста, переходы между ними и связанные инварианты, не описывая реализацию или процедуру переключения.

## Фазы

1. **Объявление** — ссылка активирует `sessionId`, клиент фиксирует наличие контекста, события ещё не обменялись.
2. **Согласование участников** — сигнальный контур сопоставляет события от второго участника, сервер удерживает контекст и подтверждает симметрию.
3. **Прямое взаимодействие** — после согласования клиентские контуры вступают в прямой обмен внутри одного `sessionId`; сигнальный контур остаётся опорой согласованности.
4. **Завершение** — обмен прекращается, сервер очищает контекст, никакие новые события не появляются до объявления нового `sessionId`.

## Допустимые переходы

- Объявление → Согласование участников, когда второе предложение и ответ сопоставлены одним `sessionId`.
- Согласование участников → Прямое взаимодействие, когда симметрия подтверждена и нет конфликтов инвариантов.
- Прямое взаимодействие → Завершение, когда участники фиксируют прекращение и запуск `sessionId` завершается.
- Завершение → Объявление, только после удаления контекста и появления новой ссылки.

Никакие другие переходы не поддерживаются; фазы образуют линейную цепочку с единственным циклом в виде нового объявления после завершения.

## Инварианты фаз

- Все события, относящиеся к фазам, прикреплены к одному `sessionId`.
- Переходы сохраняют симметрию двух участников и не допускают скрытых состояний вне перечисленных фаз.
- Серверный контур очищает контекст сразу после завершения, исключая повторное использование прежнего `sessionId`.
