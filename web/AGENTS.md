# Правила работы агента в каталоге `web/`

Path: `web/AGENTS.md`

## Назначение

Документ определяет правила работы агента при внесении изменений в браузерный слой приложения `web/`.
Он служит **картой уровня**, задающей рамки, цели и обязательные требования для всех операций внутри каталога.

---

## Карта уровня

- `app/` — модули логики браузерного приложения, включая точки инициализации и взаимодействие с контейнером DI.
- `assets/` — статические ресурсы: иконки, изображения, шрифты.
- `ui/` — композиции интерфейса (экраны, состояния, уведомления).
- `AGENTS.md` — текущий документ с правилами обновления.
- `app.js` — точка входа клиентской логики.
- `index.html` — корневой HTML приложения и точка загрузки PWA.
- `manifest.json` — манифест PWA.
- `reinstall.html` — инструмент ручной переустановки приложения (очистка кэша и сервис-воркера).
- `service-worker.js` — сервисный работник и политика обновлений.
- `version.json` — версия сборки, используемая механизмом обновления.

---

## Правило обновления версии

Любые изменения внутри каталога `web/` требуют обновления версии сборки.
Документ задаёт требования к валидному состоянию версии.

### Требуемое состояние

`version.json` содержит единственное поле:

```json
{ "version": "YYYYMMDD-HHMMSS" }
```

Значение поля является UTC-timestamp и используется системой обновления PWA.

### Условие валидной версии сборки

Состояние каталога `web/` является корректным только при выполнении следующих инвариантов:

- файл `web/version.json` присутствует в коммите, содержащем изменения в каталоге `web/`;
- файл содержит единственное поле `"version"` со значением формата `YYYYMMDD-HHMMSS`;
- значение версии отражает актуальность сборки и отличается от предыдущего;
- версия упомянута в отчёте итерации как подтверждение обновления веб-слоя.

### Исключения

- Обновление версии не требуется при изменениях за пределами `web/`.
- `reinstall.html` не участвует в версионировании, но должен оставаться доступным и функциональным. Агент проверяет неизменность его структуры.

---

## Правило DI-совместимого кода

Все модули, создаваемые контейнером `@teqfw/di`, должны соответствовать принципам, указанным в `ctx/rules/arch/teqfw/di.md`.

### Обязательные требования

- **Запрещено** использовать изменяемые публичные свойства (`this.prop = …`).
  DI-контейнер замораживает созданный объект; попытки записи вызывают ошибки.
- Изменяемое состояние хранится **только во внутреннем замыкании** модуля.
- Экспортируемый объект представляет собой набор методов, имеющих доступ к замкнутому состоянию.
- Все зависимости передаются через `{ deps }`; вложенные резолвы запрещены.
- Любой создаваемый или изменяемый агентом DI-модуль реализуется как **фабрика с замыканием**.
  Генерация классов с публичным состоянием недопустима.
- При обнаружении несоответствия агент обязан привести модуль к DI-совместной форме или запросить инструкции у человека.

---

## Правило корректности интерфейса

Любые изменения в интерфейсе должны сохранять:

- согласованность экранов и состояний согласно документам `ctx/rules/web/*`;
- неизменность архитектурных границ (`app/`, `ui/`, `assets/`);
- корректность связей между компонентами, экранами и точками входа.

Правки в UI не изменяют архитектурную модель и поддерживают её согласованность.

---

## Обязательные требования к агенту

Агент всегда поддерживает следующие инварианты поведения:

1. код согласован с документацией, которая является источником требований и имеет приоритет над текущим состоянием кода;
2. структура каталога и назначение файлов сохраняются неизменными;
3. все создаваемые и обновляемые модули соответствуют требованиям DI;
4. версия сборки обновлена при любых изменениях в `web/`, и её состояние валидно;
5. структура `reinstall.html` остаётся корректной при изменениях инфраструктуры;
6. при любых противоречиях или неясностях агент получает инструкции от человека.

---

## Итог

Документ определяет декларативную модель поведения агента на уровне `web/`, устанавливая:

- инварианты версии сборки,
- архитектурную совместимость DI,
- согласованность интерфейса,
- неизменность структуры уровня,
- приоритет документации над кодом.

Эти требования формируют стабильную и предсказуемую основу для всех изменений в каталоге `web/`.

---
